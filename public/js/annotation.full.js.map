{"version":3,"sources":["gettext.js","annotator-full.js","richText-annotator.min.js","annotator.img.js","annotator.panel.js","annotator.keywords.js","annotation.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3qGA;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1fA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"annotation.full.js","sourcesContent":["/*\nPure Javascript implementation of Uniforum message translation.\nCopyright (C) 2008 Joshua I. Miller <unrtst@cpan.org>, all rights reserved\n\nThis program is free software; you can redistribute it and/or modify it\nunder the terms of the GNU Library General Public License as published\nby the Free Software Foundation; either version 2, or (at your option)\nany later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\nLibrary General Public License for more details.\n\nYou should have received a copy of the GNU Library General Public\nLicense along with this program; if not, write to the Free Software\nFoundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307,\nUSA.\n\n=head1 NAME\n\nJavascript Gettext - Javascript implemenation of GNU Gettext API.\n\n=head1 SYNOPSIS\n\n // //////////////////////////////////////////////////////////\n // Optimum caching way\n <script language=\"javascript\" src=\"/path/LC_MESSAGES/myDomain.json\"></script>\n <script language=\"javascript\" src=\"/path/Gettext.js'></script>\n\n // assuming myDomain.json defines variable json_locale_data\n var params = {  \"domain\" : \"myDomain\",\n                 \"locale_data\" : json_locale_data\n              };\n var gt = new Gettext(params);\n // create a shortcut if you'd like\n function _ (msgid) { return gt.gettext(msgid); }\n alert(_(\"some string\"));\n // or use fully named method\n alert(gt.gettext(\"some string\"));\n // change to use a different \"domain\"\n gt.textdomain(\"anotherDomain\");\n alert(gt.gettext(\"some string\"));\n\n\n // //////////////////////////////////////////////////////////\n // The other way to load the language lookup is a \"link\" tag\n // Downside is that not all browsers cache XMLHttpRequests the\n // same way, so caching of the language data isn't guarenteed\n // across page loads.\n // Upside is that it's easy to specify multiple files\n <link rel=\"gettext\" href=\"/path/LC_MESSAGES/myDomain.json\" />\n <script language=\"javascript\" src=\"/path/Gettext.js'></script>\n\n var gt = new Gettext({ \"domain\" : \"myDomain\" });\n // rest is the same\n\n\n // //////////////////////////////////////////////////////////\n // The reson the shortcuts aren't exported by default is because they'd be\n // glued to the single domain you created. So, if you're adding i18n support\n // to some js library, you should use it as so:\n\n if (typeof(MyNamespace) == 'undefined') MyNamespace = {};\n MyNamespace.MyClass = function () {\n     var gtParms = { \"domain\" : 'MyNamespace_MyClass' };\n     this.gt = new Gettext(gtParams);\n     return this;\n };\n MyNamespace.MyClass.prototype._ = function (msgid) {\n     return this.gt.gettext(msgid);\n };\n MyNamespace.MyClass.prototype.something = function () {\n     var myString = this._(\"this will get translated\");\n };\n\n // //////////////////////////////////////////////////////////\n // Adding the shortcuts to a global scope is easier. If that's\n // ok in your app, this is certainly easier.\n var myGettext = new Gettext({ 'domain' : 'myDomain' });\n function _ (msgid) {\n     return myGettext.gettext(msgid);\n }\n alert( _(\"text\") );\n\n // //////////////////////////////////////////////////////////\n // Data structure of the json data\n // NOTE: if you're loading via the <script> tag, you can only\n // load one file, but it can contain multiple domains.\n var json_locale_data = {\n     \"MyDomain\" : {\n         \"\" : {\n             \"header_key\" : \"header value\",\n             \"header_key\" : \"header value\",\n         \"msgid\" : [ \"msgid_plural\", \"msgstr\", \"msgstr_plural\", \"msgstr_pluralN\" ],\n         \"msgctxt\\004msgid\" : [ null, \"msgstr\" ],\n         },\n     \"AnotherDomain\" : {\n         },\n     }\n\n=head1 DESCRIPTION\n\nThis is a javascript implementation of GNU Gettext, providing internationalization support for javascript. It differs from existing javascript implementations in that it will support all current Gettext features (ex. plural and context support), and will also support loading language catalogs from .mo, .po, or preprocessed json files (converter included).\n\nThe locale initialization differs from that of GNU Gettext / POSIX. Rather than setting the category, domain, and paths, and letting the libs find the right file, you must explicitly load the file at some point. The \"domain\" will still be honored. Future versions may be expanded to include support for set_locale like features.\n\n\n=head1 INSTALL\n\nTo install this module, simply copy the file lib/Gettext.js to a web accessable location, and reference it from your application.\n\n\n=head1 CONFIGURATION\n\nConfigure in one of two ways:\n\n=over\n\n=item 1. Optimal. Load language definition from statically defined json data.\n\n    <script language=\"javascript\" src=\"/path/locale/domain.json\"></script>\n\n    // in domain.json\n    json_locale_data = {\n        \"mydomain\" : {\n            // po header fields\n            \"\" : {\n                \"plural-forms\" : \"...\",\n                \"lang\" : \"en\",\n                },\n            // all the msgid strings and translations\n            \"msgid\" : [ \"msgid_plural\", \"translation\", \"plural_translation\" ],\n        },\n    };\n    // please see the included bin/po2json script for the details on this format\n\nThis method also allows you to use unsupported file formats, so long as you can parse them into the above format.\n\n=item 2. Use AJAX to load language file.\n\nUse XMLHttpRequest (actually, SJAX - syncronous) to load an external resource.\n\nSupported external formats are:\n\n=over\n\n=item * Javascript Object Notation (.json)\n\n(see bin/po2json)\n\n    type=application/json\n\n=item * Uniforum Portable Object (.po)\n\n(see GNU Gettext's xgettext)\n\n    type=application/x-po\n\n=item * Machine Object (compiled .po) (.mo)\n\nNOTE: .mo format isn't actually supported just yet, but support is planned.\n\n(see GNU Gettext's msgfmt)\n\n    type=application/x-mo\n\n=back\n\n=back\n\n=head1 METHODS\n\nThe following methods are implemented:\n\n  new Gettext(args)\n  textdomain  (domain)\n  gettext     (msgid)\n  dgettext    (domainname, msgid)\n  dcgettext   (domainname, msgid, LC_MESSAGES)\n  ngettext    (msgid, msgid_plural, count)\n  dngettext   (domainname, msgid, msgid_plural, count)\n  dcngettext  (domainname, msgid, msgid_plural, count, LC_MESSAGES)\n  pgettext    (msgctxt, msgid)\n  dpgettext   (domainname, msgctxt, msgid)\n  dcpgettext  (domainname, msgctxt, msgid, LC_MESSAGES)\n  npgettext   (msgctxt, msgid, msgid_plural, count)\n  dnpgettext  (domainname, msgctxt, msgid, msgid_plural, count)\n  dcnpgettext (domainname, msgctxt, msgid, msgid_plural, count, LC_MESSAGES)\n  strargs     (string, args_array)\n\n\n=head2 new Gettext (args)\n\nSeveral methods of loading locale data are included. You may specify a plugin or alternative method of loading data by passing the data in as the \"locale_data\" option. For example:\n\n    var get_locale_data = function () {\n        // plugin does whatever to populate locale_data\n        return locale_data;\n    };\n    var gt = new Gettext( 'domain' : 'messages',\n                          'locale_data' : get_locale_data() );\n\nThe above can also be used if locale data is specified in a statically included <SCRIPT> tag. Just specify the variable name in the call to new. Ex:\n\n    var gt = new Gettext( 'domain' : 'messages',\n                          'locale_data' : json_locale_data_variable );\n\nFinally, you may load the locale data by referencing it in a <LINK> tag. Simply exclude the 'locale_data' option, and all <LINK rel=\"gettext\" ...> items will be tried. The <LINK> should be specified as:\n\n    <link rel=\"gettext\" type=\"application/json\" href=\"/path/to/file.json\">\n    <link rel=\"gettext\" type=\"text/javascript\"  href=\"/path/to/file.json\">\n    <link rel=\"gettext\" type=\"application/x-po\" href=\"/path/to/file.po\">\n    <link rel=\"gettext\" type=\"application/x-mo\" href=\"/path/to/file.mo\">\n\nargs:\n\n=over\n\n=item domain\n\nThe Gettext domain, not www.whatev.com. It's usually your applications basename. If the .po file was \"myapp.po\", this would be \"myapp\".\n\n=item locale_data\n\nRaw locale data (in json structure). If specified, from_link data will be ignored.\n\n=back\n\n=cut\n\n*/\n\nGettext = function (args) {\n    this.domain         = 'messages';\n    // locale_data will be populated from <link...> if not specified in args\n    this.locale_data    = undefined;\n\n    // set options\n    var options = [ \"domain\", \"locale_data\" ];\n    if (this.isValidObject(args)) {\n        for (var i in args) {\n            for (var j=0; j<options.length; j++) {\n                if (i == options[j]) {\n                    // don't set it if it's null or undefined\n                    if (this.isValidObject(args[i]))\n                        this[i] = args[i];\n                }\n            }\n        }\n    }\n\n\n    // try to load the lang file from somewhere\n    this.try_load_lang();\n\n    return this;\n}\n\nGettext.context_glue = \"\\004\";\nGettext._locale_data = {};\n\nGettext.prototype.try_load_lang = function() {\n    // check to see if language is statically included\n    if (typeof(this.locale_data) != 'undefined') {\n        // we're going to reformat it, and overwrite the variable\n        var locale_copy = this.locale_data;\n        this.locale_data = undefined;\n        this.parse_locale_data(locale_copy);\n\n        if (typeof(Gettext._locale_data[this.domain]) == 'undefined') {\n            throw new Error(\"Error: Gettext 'locale_data' does not contain the domain '\"+this.domain+\"'\");\n        }\n    }\n\n\n    // try loading from JSON\n    // get lang links\n    var lang_link = this.get_lang_refs();\n\n    if (typeof(lang_link) == 'object' && lang_link.length > 0) {\n        // NOTE: there will be a delay here, as this is async.\n        // So, any i18n calls made right after page load may not\n        // get translated.\n        // XXX: we may want to see if we can \"fix\" this behavior\n        for (var i=0; i<lang_link.length; i++) {\n            var link = lang_link[i];\n            if (link.type == 'application/json') {\n                if (! this.try_load_lang_json(link.href) ) {\n                    throw new Error(\"Error: Gettext 'try_load_lang_json' failed. Unable to exec xmlhttprequest for link [\"+link.href+\"]\");\n                }\n            } else if (link.type == 'application/x-po') {\n                if (! this.try_load_lang_po(link.href) ) {\n                    throw new Error(\"Error: Gettext 'try_load_lang_po' failed. Unable to exec xmlhttprequest for link [\"+link.href+\"]\");\n                }\n            } else {\n                // TODO: implement the other types (.mo)\n                throw new Error(\"TODO: link type [\"+link.type+\"] found, and support is planned, but not implemented at this time.\");\n            }\n        }\n    }\n};\n\n// This takes the bin/po2json'd data, and moves it into an internal form\n// for use in our lib, and puts it in our object as:\n//  Gettext._locale_data = {\n//      domain : {\n//          head : { headfield : headvalue },\n//          msgs : {\n//              msgid : [ msgid_plural, msgstr, msgstr_plural ],\n//          },\nGettext.prototype.parse_locale_data = function(locale_data) {\n    if (typeof(Gettext._locale_data) == 'undefined') {\n        Gettext._locale_data = { };\n    }\n\n    // suck in every domain defined in the supplied data\n    for (var domain in locale_data) {\n        // skip empty specs (flexibly)\n        if ((! locale_data.hasOwnProperty(domain)) || (! this.isValidObject(locale_data[domain])))\n            continue;\n        // skip if it has no msgid's\n        var has_msgids = false;\n        for (var msgid in locale_data[domain]) {\n            has_msgids = true;\n            break;\n        }\n        if (! has_msgids) continue;\n\n        // grab shortcut to data\n        var data = locale_data[domain];\n\n        // if they specifcy a blank domain, default to \"messages\"\n        if (domain == \"\") domain = \"messages\";\n        // init the data structure\n        if (! this.isValidObject(Gettext._locale_data[domain]) )\n            Gettext._locale_data[domain] = { };\n        if (! this.isValidObject(Gettext._locale_data[domain].head) )\n            Gettext._locale_data[domain].head = { };\n        if (! this.isValidObject(Gettext._locale_data[domain].msgs) )\n            Gettext._locale_data[domain].msgs = { };\n\n        for (var key in data) {\n            if (key == \"\") {\n                var header = data[key];\n                for (var head in header) {\n                    var h = head.toLowerCase();\n                    Gettext._locale_data[domain].head[h] = header[head];\n                }\n            } else {\n                Gettext._locale_data[domain].msgs[key] = data[key];\n            }\n        }\n    }\n\n    // build the plural forms function\n    for (var domain in Gettext._locale_data) {\n        if (this.isValidObject(Gettext._locale_data[domain].head['plural-forms']) &&\n            typeof(Gettext._locale_data[domain].head.plural_func) == 'undefined') {\n            // untaint data\n            var plural_forms = Gettext._locale_data[domain].head['plural-forms'];\n            var pf_re = new RegExp('^(\\\\s*nplurals\\\\s*=\\\\s*[0-9]+\\\\s*;\\\\s*plural\\\\s*=\\\\s*(?:\\\\s|[-\\\\?\\\\|&=!<>+*/%:;a-zA-Z0-9_\\(\\)])+)', 'm');\n            if (pf_re.test(plural_forms)) {\n                //ex english: \"Plural-Forms: nplurals=2; plural=(n != 1);\\n\"\n                //pf = \"nplurals=2; plural=(n != 1);\";\n                //ex russian: nplurals=3; plural=(n%10==1 && n%100!=11 ? 0 : n%10>=2 && n%10< =4 && (n%100<10 or n%100>=20) ? 1 : 2)\n                //pf = \"nplurals=3; plural=(n%10==1 && n%100!=11 ? 0 : n%10>=2 && n%10<=4 && (n%100<10 || n%100>=20) ? 1 : 2)\";\n\n                var pf = Gettext._locale_data[domain].head['plural-forms'];\n                if (! /;\\s*$/.test(pf)) pf = pf.concat(';');\n                /* We used to use eval, but it seems IE has issues with it.\n                 * We now use \"new Function\", though it carries a slightly\n                 * bigger performance hit.\n                var code = 'function (n) { var plural; var nplurals; '+pf+' return { \"nplural\" : nplurals, \"plural\" : (plural === true ? 1 : plural ? plural : 0) }; };';\n                Gettext._locale_data[domain].head.plural_func = eval(\"(\"+code+\")\");\n                */\n                var code = 'var plural; var nplurals; '+pf+' return { \"nplural\" : nplurals, \"plural\" : (plural === true ? 1 : plural ? plural : 0) };';\n                Gettext._locale_data[domain].head.plural_func = new Function(\"n\", code);\n            } else {\n                throw new Error(\"Syntax error in language file. Plural-Forms header is invalid [\"+plural_forms+\"]\");\n            }   \n\n        // default to english plural form\n        } else if (typeof(Gettext._locale_data[domain].head.plural_func) == 'undefined') {\n            Gettext._locale_data[domain].head.plural_func = function (n) {\n                var p = (n != 1) ? 1 : 0;\n                return { 'nplural' : 2, 'plural' : p };\n                };\n        } // else, plural_func already created\n    }\n\n    return;\n};\n\n\n// try_load_lang_po : do an ajaxy call to load in the .po lang defs\nGettext.prototype.try_load_lang_po = function(uri) {\n    var data = this.sjax(uri);\n    if (! data) return;\n\n    var domain = this.uri_basename(uri);\n    var parsed = this.parse_po(data);\n\n    var rv = {};\n    // munge domain into/outof header\n    if (parsed) {\n        if (! parsed[\"\"]) parsed[\"\"] = {};\n        if (! parsed[\"\"][\"domain\"]) parsed[\"\"][\"domain\"] = domain;\n        domain = parsed[\"\"][\"domain\"];\n        rv[domain] = parsed;\n\n        this.parse_locale_data(rv);\n    }\n\n    return 1;\n};\n\nGettext.prototype.uri_basename = function(uri) {\n    var rv;\n    if (rv = uri.match(/^(.*\\/)?(.*)/)) {\n        var ext_strip;\n        if (ext_strip = rv[2].match(/^(.*)\\..+$/))\n            return ext_strip[1];\n        else\n            return rv[2];\n    } else {\n        return \"\";\n    }\n};\n\nGettext.prototype.parse_po = function(data) {\n    var rv = {};\n    var buffer = {};\n    var lastbuffer = \"\";\n    var errors = [];\n    var lines = data.split(\"\\n\");\n    for (var i=0; i<lines.length; i++) {\n        // chomp\n        lines[i] = lines[i].replace(/(\\n|\\r)+$/, '');\n\n        var match;\n\n        // Empty line / End of an entry.\n        if (/^$/.test(lines[i])) {\n            if (typeof(buffer['msgid']) != 'undefined') {\n                var msg_ctxt_id = (typeof(buffer['msgctxt']) != 'undefined' &&\n                                   buffer['msgctxt'].length) ?\n                                  buffer['msgctxt']+Gettext.context_glue+buffer['msgid'] :\n                                  buffer['msgid'];\n                var msgid_plural = (typeof(buffer['msgid_plural']) != 'undefined' &&\n                                    buffer['msgid_plural'].length) ?\n                                   buffer['msgid_plural'] :\n                                   null;\n\n                // find msgstr_* translations and push them on\n                var trans = [];\n                for (var str in buffer) {\n                    var match;\n                    if (match = str.match(/^msgstr_(\\d+)/))\n                        trans[parseInt(match[1])] = buffer[str];\n                }\n                trans.unshift(msgid_plural);\n\n                // only add it if we've got a translation\n                // NOTE: this doesn't conform to msgfmt specs\n                if (trans.length > 1) rv[msg_ctxt_id] = trans;\n\n                buffer = {};\n                lastbuffer = \"\";\n            }\n\n        // comments\n        } else if (/^#/.test(lines[i])) {\n            continue;\n\n        // msgctxt\n        } else if (match = lines[i].match(/^msgctxt\\s+(.*)/)) {\n            lastbuffer = 'msgctxt';\n            buffer[lastbuffer] = this.parse_po_dequote(match[1]);\n\n        // msgid\n        } else if (match = lines[i].match(/^msgid\\s+(.*)/)) {\n            lastbuffer = 'msgid';\n            buffer[lastbuffer] = this.parse_po_dequote(match[1]);\n\n        // msgid_plural\n        } else if (match = lines[i].match(/^msgid_plural\\s+(.*)/)) {\n            lastbuffer = 'msgid_plural';\n            buffer[lastbuffer] = this.parse_po_dequote(match[1]);\n\n        // msgstr\n        } else if (match = lines[i].match(/^msgstr\\s+(.*)/)) {\n            lastbuffer = 'msgstr_0';\n            buffer[lastbuffer] = this.parse_po_dequote(match[1]);\n\n        // msgstr[0] (treak like msgstr)\n        } else if (match = lines[i].match(/^msgstr\\[0\\]\\s+(.*)/)) {\n            lastbuffer = 'msgstr_0';\n            buffer[lastbuffer] = this.parse_po_dequote(match[1]);\n\n        // msgstr[n]\n        } else if (match = lines[i].match(/^msgstr\\[(\\d+)\\]\\s+(.*)/)) {\n            lastbuffer = 'msgstr_'+match[1];\n            buffer[lastbuffer] = this.parse_po_dequote(match[2]);\n\n        // continued string\n        } else if (/^\"/.test(lines[i])) {\n            buffer[lastbuffer] += this.parse_po_dequote(lines[i]);\n\n        // something strange\n        } else {\n            errors.push(\"Strange line [\"+i+\"] : \"+lines[i]);\n        }\n    }\n\n\n    // handle the final entry\n    if (typeof(buffer['msgid']) != 'undefined') {\n        var msg_ctxt_id = (typeof(buffer['msgctxt']) != 'undefined' &&\n                           buffer['msgctxt'].length) ?\n                          buffer['msgctxt']+Gettext.context_glue+buffer['msgid'] :\n                          buffer['msgid'];\n        var msgid_plural = (typeof(buffer['msgid_plural']) != 'undefined' &&\n                            buffer['msgid_plural'].length) ?\n                           buffer['msgid_plural'] :\n                           null;\n\n        // find msgstr_* translations and push them on\n        var trans = [];\n        for (var str in buffer) {\n            var match;\n            if (match = str.match(/^msgstr_(\\d+)/))\n                trans[parseInt(match[1])] = buffer[str];\n        }\n        trans.unshift(msgid_plural);\n\n        // only add it if we've got a translation\n        // NOTE: this doesn't conform to msgfmt specs\n        if (trans.length > 1) rv[msg_ctxt_id] = trans;\n\n        buffer = {};\n        lastbuffer = \"\";\n    }\n\n\n    // parse out the header\n    if (rv[\"\"] && rv[\"\"][1]) {\n        var cur = {};\n        var hlines = rv[\"\"][1].split(/\\\\n/);\n        for (var i=0; i<hlines.length; i++) {\n            if (! hlines.length) continue;\n\n            var pos = hlines[i].indexOf(':', 0);\n            if (pos != -1) {\n                var key = hlines[i].substring(0, pos);\n                var val = hlines[i].substring(pos +1);\n                var keylow = key.toLowerCase();\n\n                if (cur[keylow] && cur[keylow].length) {\n                    errors.push(\"SKIPPING DUPLICATE HEADER LINE: \"+hlines[i]);\n                } else if (/#-#-#-#-#/.test(keylow)) {\n                    errors.push(\"SKIPPING ERROR MARKER IN HEADER: \"+hlines[i]);\n                } else {\n                    // remove begining spaces if any\n                    val = val.replace(/^\\s+/, '');\n                    cur[keylow] = val;\n                }\n\n            } else {\n                errors.push(\"PROBLEM LINE IN HEADER: \"+hlines[i]);\n                cur[hlines[i]] = '';\n            }\n        }\n\n        // replace header string with assoc array\n        rv[\"\"] = cur;\n    } else {\n        rv[\"\"] = {};\n    }\n\n    // TODO: XXX: if there are errors parsing, what do we want to do?\n    // GNU Gettext silently ignores errors. So will we.\n    // alert( \"Errors parsing po file:\\n\" + errors.join(\"\\n\") );\n\n    return rv;\n};\n\n\nGettext.prototype.parse_po_dequote = function(str) {\n    var match;\n    if (match = str.match(/^\"(.*)\"/)) {\n        str = match[1];\n    }\n    // unescale all embedded quotes (fixes bug #17504)\n    str = str.replace(/\\\\\"/g, \"\\\"\");\n    return str;\n};\n\n\n// try_load_lang_json : do an ajaxy call to load in the lang defs\nGettext.prototype.try_load_lang_json = function(uri) {\n    var data = this.sjax(uri);\n    if (! data) return;\n\n    var rv = this.JSON(data);\n    this.parse_locale_data(rv);\n\n    return 1;\n};\n\n// this finds all <link> tags, filters out ones that match our\n// specs, and returns a list of hashes of those\nGettext.prototype.get_lang_refs = function() {\n    var langs = new Array();\n    var links = document.getElementsByTagName(\"link\");\n    // find all <link> tags in dom; filter ours\n    for (var i=0; i<links.length; i++) {\n        if (links[i].rel == 'gettext' && links[i].href) {\n            if (typeof(links[i].type) == 'undefined' ||\n                links[i].type == '') {\n                if (/\\.json$/i.test(links[i].href)) {\n                    links[i].type = 'application/json';\n                } else if (/\\.js$/i.test(links[i].href)) {\n                    links[i].type = 'application/json';\n                } else if (/\\.po$/i.test(links[i].href)) {\n                    links[i].type = 'application/x-po';\n                } else if (/\\.mo$/i.test(links[i].href)) {\n                    links[i].type = 'application/x-mo';\n                } else {\n                    throw new Error(\"LINK tag with rel=gettext found, but the type and extension are unrecognized.\");\n                }\n            }\n\n            links[i].type = links[i].type.toLowerCase();\n            if (links[i].type == 'application/json') {\n                links[i].type = 'application/json';\n            } else if (links[i].type == 'text/javascript') {\n                links[i].type = 'application/json';\n            } else if (links[i].type == 'application/x-po') {\n                links[i].type = 'application/x-po';\n            } else if (links[i].type == 'application/x-mo') {\n                links[i].type = 'application/x-mo';\n            } else {\n                throw new Error(\"LINK tag with rel=gettext found, but the type attribute [\"+links[i].type+\"] is unrecognized.\");\n            }\n\n            langs.push(links[i]);\n        }\n    }\n    return langs;\n};\n\n\n/*\n\n=head2 textdomain( domain )\n\nSet domain for future gettext() calls\n\nA  message  domain  is  a  set of translatable msgid messages. Usually,\nevery software package has its own message domain. The domain  name  is\nused to determine the message catalog where a translation is looked up;\nit must be a non-empty string.\n\nThe current message domain is used by the gettext, ngettext, pgettext,\nnpgettext functions, and by the dgettext, dcgettext, dngettext, dcngettext,\ndpgettext, dcpgettext, dnpgettext and dcnpgettext functions when called\nwith a NULL domainname argument.\n\nIf domainname is not NULL, the current message domain is set to\ndomainname.\n\nIf domainname is undefined, null, or empty string, the function returns\nthe current message domain.\n\nIf  successful,  the  textdomain  function  returns the current message\ndomain, after possibly changing it. (ie. if you set a new domain, the \nvalue returned will NOT be the previous domain).\n\n=cut\n\n*/\nGettext.prototype.textdomain = function (domain) {\n    if (domain && domain.length) this.domain = domain;\n    return this.domain;\n}\n\n/*\n\n=head2 gettext( MSGID )\n\nReturns the translation for B<MSGID>.  Example:\n\n    alert( gt.gettext(\"Hello World!\\n\") );\n\nIf no translation can be found, the unmodified B<MSGID> is returned,\ni. e. the function can I<never> fail, and will I<never> mess up your\noriginal message.\n\nOne common mistake is to interpolate a variable into the string like this:\n\n  var translated = gt.gettext(\"Hello \" + full_name);\n\nThe interpolation will happen before it's passed to gettext, and it's \nunlikely you'll have a translation for every \"Hello Tom\" and \"Hello Dick\"\nand \"Hellow Harry\" that may arise.\n\nUse C<strargs()> (see below) to solve this problem:\n\n  var translated = Gettext.strargs( gt.gettext(\"Hello %1\"), [full_name] );\n\nThis is espeically useful when multiple replacements are needed, as they \nmay not appear in the same order within the translation. As an English to\nFrench example:\n\n  Expected result: \"This is the red ball\"\n  English: \"This is the %1 %2\"\n  French:  \"C'est le %2 %1\"\n  Code: Gettext.strargs( gt.gettext(\"This is the %1 %2\"), [\"red\", \"ball\"] );\n\n(The example is stupid because neither color nor thing will get\ntranslated here ...).\n\n=head2 dgettext( TEXTDOMAIN, MSGID )\n\nLike gettext(), but retrieves the message for the specified \nB<TEXTDOMAIN> instead of the default domain.  In case you wonder what\na textdomain is, see above section on the textdomain() call.\n\n=head2 dcgettext( TEXTDOMAIN, MSGID, CATEGORY )\n\nLike dgettext() but retrieves the message from the specified B<CATEGORY>\ninstead of the default category C<LC_MESSAGES>.\n\nNOTE: the categories are really useless in javascript context. This is\nhere for GNU Gettext API compatability. In practice, you'll never need\nto use this. This applies to all the calls including the B<CATEGORY>.\n\n\n=head2 ngettext( MSGID, MSGID_PLURAL, COUNT )\n\nRetrieves the correct translation for B<COUNT> items.  In legacy software\nyou will often find something like:\n\n    alert( count + \" file(s) deleted.\\n\" );\n\nor\n\n    printf(count + \" file%s deleted.\\n\", $count == 1 ? '' : 's');\n\nI<NOTE: javascript lacks a builtin printf, so the above isn't a working example>\n\nThe first example looks awkward, the second will only work in English\nand languages with similar plural rules.  Before ngettext() was introduced,\nthe best practice for internationalized programs was:\n\n    if (count == 1) {\n        alert( gettext(\"One file deleted.\\n\") );\n    } else {\n        printf( gettext(\"%d files deleted.\\n\"), count );\n    }\n\nThis is a nuisance for the programmer and often still not sufficient\nfor an adequate translation.  Many languages have completely different\nideas on numerals.  Some (French, Italian, ...) treat 0 and 1 alike,\nothers make no distinction at all (Japanese, Korean, Chinese, ...),\nothers have two or more plural forms (Russian, Latvian, Czech,\nPolish, ...).  The solution is:\n\n    printf( ngettext(\"One file deleted.\\n\",\n                     \"%d files deleted.\\n\",\n                     count), // argument to ngettext!\n            count);          // argument to printf!\n\nIn English, or if no translation can be found, the first argument\n(B<MSGID>) is picked if C<count> is one, the second one otherwise.\nFor other languages, the correct plural form (of 1, 2, 3, 4, ...)\nis automatically picked, too.  You don't have to know anything about\nthe plural rules in the target language, ngettext() will take care\nof that.\n\nThis is most of the time sufficient but you will have to prove your\ncreativity in cases like\n\n    \"%d file(s) deleted, and %d file(s) created.\\n\"\n\nThat said, javascript lacks C<printf()> support. Supplied with Gettext.js\nis the C<strargs()> method, which can be used for these cases:\n\n    Gettext.strargs( gt.ngettext( \"One file deleted.\\n\",\n                                  \"%d files deleted.\\n\",\n                                  count), // argument to ngettext!\n                     count); // argument to strargs!\n\nNOTE: the variable replacement isn't done for you, so you must\ndo it yourself as in the above.\n\n=head2 dngettext( TEXTDOMAIN, MSGID, MSGID_PLURAL, COUNT )\n\nLike ngettext() but retrieves the translation from the specified\ntextdomain instead of the default domain.\n\n=head2 dcngettext( TEXTDOMAIN, MSGID, MSGID_PLURAL, COUNT, CATEGORY )\n\nLike dngettext() but retrieves the translation from the specified\ncategory, instead of the default category C<LC_MESSAGES>.\n\n\n=head2 pgettext( MSGCTXT, MSGID )\n\nReturns the translation of MSGID, given the context of MSGCTXT.\n\nBoth items are used as a unique key into the message catalog.\n\nThis allows the translator to have two entries for words that may\ntranslate to different foreign words based on their context. For\nexample, the word \"View\" may be a noun or a verb, which may be\nused in a menu as File->View or View->Source.\n\n    alert( pgettext( \"Verb: To View\", \"View\" ) );\n    alert( pgettext( \"Noun: A View\", \"View\"  ) );\n\nThe above will both lookup different entries in the message catalog.\n\nIn English, or if no translation can be found, the second argument\n(B<MSGID>) is returned.\n\n=head2 dpgettext( TEXTDOMAIN, MSGCTXT, MSGID )\n\nLike pgettext(), but retrieves the message for the specified \nB<TEXTDOMAIN> instead of the default domain.\n\n=head2 dcpgettext( TEXTDOMAIN, MSGCTXT, MSGID, CATEGORY )\n\nLike dpgettext() but retrieves the message from the specified B<CATEGORY>\ninstead of the default category C<LC_MESSAGES>.\n\n\n=head2 npgettext( MSGCTXT, MSGID, MSGID_PLURAL, COUNT )\n\nLike ngettext() with the addition of context as in pgettext().\n\nIn English, or if no translation can be found, the second argument\n(MSGID) is picked if B<COUNT> is one, the third one otherwise.\n\n=head2 dnpgettext( TEXTDOMAIN, MSGCTXT, MSGID, MSGID_PLURAL, COUNT )\n\nLike npgettext() but retrieves the translation from the specified\ntextdomain instead of the default domain.\n\n=head2 dcnpgettext( TEXTDOMAIN, MSGCTXT, MSGID, MSGID_PLURAL, COUNT, CATEGORY )\n\nLike dnpgettext() but retrieves the translation from the specified\ncategory, instead of the default category C<LC_MESSAGES>.\n\n=cut\n\n*/\n\n// gettext\nGettext.prototype.gettext = function (msgid) {\n    var msgctxt;\n    var msgid_plural;\n    var n;\n    var category;\n    return this.dcnpgettext(null, msgctxt, msgid, msgid_plural, n, category);\n};\n\nGettext.prototype.dgettext = function (domain, msgid) {\n    var msgctxt;\n    var msgid_plural;\n    var n;\n    var category;\n    return this.dcnpgettext(domain, msgctxt, msgid, msgid_plural, n, category);\n};\n\nGettext.prototype.dcgettext = function (domain, msgid, category) {\n    var msgctxt;\n    var msgid_plural;\n    var n;\n    return this.dcnpgettext(domain, msgctxt, msgid, msgid_plural, n, category);\n};\n\n// ngettext\nGettext.prototype.ngettext = function (msgid, msgid_plural, n) {\n    var msgctxt;\n    var category;\n    return this.dcnpgettext(null, msgctxt, msgid, msgid_plural, n, category);\n};\n\nGettext.prototype.dngettext = function (domain, msgid, msgid_plural, n) {\n    var msgctxt;\n    var category;\n    return this.dcnpgettext(domain, msgctxt, msgid, msgid_plural, n, category);\n};\n\nGettext.prototype.dcngettext = function (domain, msgid, msgid_plural, n, category) {\n    var msgctxt;\n    return this.dcnpgettext(domain, msgctxt, msgid, msgid_plural, n, category, category);\n};\n\n// pgettext\nGettext.prototype.pgettext = function (msgctxt, msgid) {\n    var msgid_plural;\n    var n;\n    var category;\n    return this.dcnpgettext(null, msgctxt, msgid, msgid_plural, n, category);\n};\n\nGettext.prototype.dpgettext = function (domain, msgctxt, msgid) {\n    var msgid_plural;\n    var n;\n    var category;\n    return this.dcnpgettext(domain, msgctxt, msgid, msgid_plural, n, category);\n};\n\nGettext.prototype.dcpgettext = function (domain, msgctxt, msgid, category) {\n    var msgid_plural;\n    var n;\n    return this.dcnpgettext(domain, msgctxt, msgid, msgid_plural, n, category);\n};\n\n// npgettext\nGettext.prototype.npgettext = function (msgctxt, msgid, msgid_plural, n) {\n    var category;\n    return this.dcnpgettext(null, msgctxt, msgid, msgid_plural, n, category);\n};\n\nGettext.prototype.dnpgettext = function (domain, msgctxt, msgid, msgid_plural, n) {\n    var category;\n    return this.dcnpgettext(domain, msgctxt, msgid, msgid_plural, n, category);\n};\n\n// this has all the options, so we use it for all of them.\nGettext.prototype.dcnpgettext = function (domain, msgctxt, msgid, msgid_plural, n, category) {\n    if (! this.isValidObject(msgid)) return '';\n\n    var plural = this.isValidObject(msgid_plural);\n    var msg_ctxt_id = this.isValidObject(msgctxt) ? msgctxt+Gettext.context_glue+msgid : msgid;\n\n    var domainname = this.isValidObject(domain)      ? domain :\n                     this.isValidObject(this.domain) ? this.domain :\n                                                       'messages';\n\n    // category is always LC_MESSAGES. We ignore all else\n    var category_name = 'LC_MESSAGES';\n    var category = 5;\n\n    var locale_data = new Array();\n    if (typeof(Gettext._locale_data) != 'undefined' &&\n        this.isValidObject(Gettext._locale_data[domainname])) {\n        locale_data.push( Gettext._locale_data[domainname] );\n\n    } else if (typeof(Gettext._locale_data) != 'undefined') {\n        // didn't find domain we're looking for. Search all of them.\n        for (var dom in Gettext._locale_data) {\n            locale_data.push( Gettext._locale_data[dom] );\n        }\n    }\n\n    var trans = [];\n    var found = false;\n    var domain_used; // so we can find plural-forms if needed\n    if (locale_data.length) {\n        for (var i=0; i<locale_data.length; i++) {\n            var locale = locale_data[i];\n            if (this.isValidObject(locale.msgs[msg_ctxt_id])) {\n                // make copy of that array (cause we'll be destructive)\n                for (var j=0; j<locale.msgs[msg_ctxt_id].length; j++) {\n                    trans[j] = locale.msgs[msg_ctxt_id][j];\n                }\n                trans.shift(); // throw away the msgid_plural\n                domain_used = locale;\n                found = true;\n                // only break if found translation actually has a translation.\n                if ( trans.length > 0 && trans[0].length != 0 )\n                    break;\n            }\n        }\n    }\n\n    // default to english if we lack a match, or match has zero length\n    if ( trans.length == 0 || trans[0].length == 0 ) {\n        trans = [ msgid, msgid_plural ];\n    }\n\n    var translation = trans[0];\n    if (plural) {\n        var p;\n        if (found && this.isValidObject(domain_used.head.plural_func) ) {\n            var rv = domain_used.head.plural_func(n);\n            if (! rv.plural) rv.plural = 0;\n            if (! rv.nplural) rv.nplural = 0;\n            // if plurals returned is out of bound for total plural forms\n            if (rv.nplural <= rv.plural) rv.plural = 0;\n            p = rv.plural;\n        } else {\n            p = (n != 1) ? 1 : 0;\n        }\n        if (this.isValidObject(trans[p]))\n            translation = trans[p];\n    }\n\n    return translation;\n};\n\n\n/*\n\n=head2 strargs (string, argument_array)\n\n  string : a string that potentially contains formatting characters.\n  argument_array : an array of positional replacement values\n\nThis is a utility method to provide some way to support positional parameters within a string, as javascript lacks a printf() method.\n\nThe format is similar to printf(), but greatly simplified (ie. fewer features).\n\nAny percent signs followed by numbers are replaced with the corrosponding item from the B<argument_array>.\n\nExample:\n\n    var string = \"%2 roses are red, %1 violets are blue\";\n    var args   = new Array(\"10\", \"15\");\n    var result = Gettext.strargs(string, args);\n    // result is \"15 roses are red, 10 violets are blue\"\n\nThe format numbers are 1 based, so the first itme is %1.\n\nA lone percent sign may be escaped by preceeding it with another percent sign.\n\nA percent sign followed by anything other than a number or another percent sign will be passed through as is.\n\nSome more examples should clear up any abmiguity. The following were called with the orig string, and the array as Array(\"[one]\", \"[two]\") :\n\n  orig string \"blah\" becomes \"blah\"\n  orig string \"\" becomes \"\"\n  orig string \"%%\" becomes \"%\"\n  orig string \"%%%\" becomes \"%%\"\n  orig string \"%%%%\" becomes \"%%\"\n  orig string \"%%%%%\" becomes \"%%%\"\n  orig string \"tom%%dick\" becomes \"tom%dick\"\n  orig string \"thing%1bob\" becomes \"thing[one]bob\"\n  orig string \"thing%1%2bob\" becomes \"thing[one][two]bob\"\n  orig string \"thing%1asdf%2asdf\" becomes \"thing[one]asdf[two]asdf\"\n  orig string \"%1%2%3\" becomes \"[one][two]\"\n  orig string \"tom%1%%2%aDick\" becomes \"tom[one]%2%aDick\"\n\nThis is especially useful when using plurals, as the string will nearly always contain the number.\n\nIt's also useful in translated strings where the translator may have needed to move the position of the parameters.\n\nFor example:\n\n  var count = 14;\n  Gettext.strargs( gt.ngettext('one banana', '%1 bananas', count), [count] );\n\nNOTE: this may be called as an instance method, or as a class method.\n\n  // instance method:\n  var gt = new Gettext(params);\n  gt.strargs(string, args);\n\n  // class method:\n  Gettext.strargs(string, args);\n\n=cut\n\n*/\n/* utility method, since javascript lacks a printf */\nGettext.strargs = function (str, args) {\n    // make sure args is an array\n    if ( null == args ||\n         'undefined' == typeof(args) ) {\n        args = [];\n    } else if (args.constructor != Array) {\n        args = [args];\n    }\n\n    // NOTE: javascript lacks support for zero length negative look-behind\n    // in regex, so we must step through w/ index.\n    // The perl equiv would simply be:\n    //    $string =~ s/(?<!\\%)\\%([0-9]+)/$args[$1]/g;\n    //    $string =~ s/\\%\\%/\\%/g; # restore escaped percent signs\n\n    var newstr = \"\";\n    while (true) {\n        var i = str.indexOf('%');\n        var match_n;\n\n        // no more found. Append whatever remains\n        if (i == -1) {\n            newstr += str;\n            break;\n        }\n\n        // we found it, append everything up to that\n        newstr += str.substr(0, i);\n\n        // check for escpaed %%\n        if (str.substr(i, 2) == '%%') {\n            newstr += '%';\n            str = str.substr((i+2));\n\n        // % followed by number\n        } else if ( match_n = str.substr(i).match(/^%(\\d+)/) ) {\n            var arg_n = parseInt(match_n[1]);\n            var length_n = match_n[1].length;\n            if ( arg_n > 0 && args[arg_n -1] != null && typeof(args[arg_n -1]) != 'undefined' )\n                newstr += args[arg_n -1];\n            str = str.substr( (i + 1 + length_n) );\n\n        // % followed by some other garbage - just remove the %\n        } else {\n            newstr += '%';\n            str = str.substr((i+1));\n        }\n    }\n\n    return newstr;\n}\n\n/* instance method wrapper of strargs */\nGettext.prototype.strargs = function (str, args) {\n    return Gettext.strargs(str, args);\n}\n\n/* verify that something is an array */\nGettext.prototype.isArray = function (thisObject) {\n    return this.isValidObject(thisObject) && thisObject.constructor == Array;\n};\n\n/* verify that an object exists and is valid */\nGettext.prototype.isValidObject = function (thisObject) {\n    if (null == thisObject) {\n        return false;\n    } else if ('undefined' == typeof(thisObject) ) {\n        return false;\n    } else {\n        return true;\n    }\n};\n\nGettext.prototype.sjax = function (uri) {\n    var xmlhttp;\n    if (window.XMLHttpRequest) {\n        xmlhttp = new XMLHttpRequest();\n    } else if (navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) {\n        xmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\");\n    } else {\n        xmlhttp = new ActiveXObject(\"Msxml2.XMLHTTP\");\n    }\n\n    if (! xmlhttp)\n        throw new Error(\"Your browser doesn't do Ajax. Unable to support external language files.\");\n\n    xmlhttp.open('GET', uri, false);\n    try { xmlhttp.send(null); }\n    catch (e) { return; }\n\n    // we consider status 200 and 0 as ok.\n    // 0 happens when we request local file, allowing this to run on local files\n    var sjax_status = xmlhttp.status;\n    if (sjax_status == 200 || sjax_status == 0) {\n        return xmlhttp.responseText;\n    } else {\n        var error = xmlhttp.statusText + \" (Error \" + xmlhttp.status + \")\";\n        if (xmlhttp.responseText.length) {\n            error += \"\\n\" + xmlhttp.responseText;\n        }\n        alert(error);\n        return;\n    }\n}\n\nGettext.prototype.JSON = function (data) {\n    return eval('(' + data + ')');\n}\n\n\n/*\n\n=head1 NOTES\n\nThese are some notes on the internals\n\n=over\n\n=item LOCALE CACHING\n\nLoaded locale data is currently cached class-wide. This means that if two scripts are both using Gettext.js, and both share the same gettext domain, that domain will only be loaded once. This will allow you to grab a new object many times from different places, utilize the same domain, and share a single translation file. The downside is that a domain won't be RE-loaded if a new object is instantiated on a domain that had already been instantiated.\n\n=back\n\n=head1 BUGS / TODO\n\n=over\n\n=item error handling\n\nCurrently, there are several places that throw errors. In GNU Gettext, there are no fatal errors, which allows text to still be displayed regardless of how broken the environment becomes. We should evaluate and determine where we want to stand on that issue.\n\n=item syncronous only support (no ajax support)\n\nCurrently, fetching language data is done purely syncronous, which means the page will halt while those files are fetched/loaded.\n\nThis is often what you want, as then following translation requests will actually be translated. However, if all your calls are done dynamically (ie. error handling only or something), loading in the background may be more adventagous.\n\nIt's still recommended to use the statically defined <script ...> method, which should have the same delay, but it will cache the result.\n\n=item domain support\n\ndomain support while using shortcut methods like C<_('string')> or C<i18n('string')>.\n\nUnder normal apps, the domain is usually set globally to the app, and a single language file is used. Under javascript, you may have multiple libraries or applications needing translation support, but the namespace is essentially global.\n\nIt's recommended that your app initialize it's own shortcut with it's own domain.  (See examples/wrapper/i18n.js for an example.)\n\nBasically, you'll want to accomplish something like this:\n\n    // in some other .js file that needs i18n\n    this.i18nObj = new i18n;\n    this.i18n = this.i18nObj.init('domain');\n    // do translation\n    alert( this.i18n(\"string\") );\n\nIf you use this raw Gettext object, then this is all handled for you, as you have your own object then, and will be calling C<myGettextObject.gettext('string')> and such.\n\n\n=item encoding\n\nMay want to add encoding/reencoding stuff. See GNU iconv, or the perl module Locale::Recode from libintl-perl.\n\n=back\n\n\n=head1 COMPATABILITY\n\nThis has been tested on the following browsers. It may work on others, but these are all those to which I have access.\n\n    FF1.5, FF2, FF3, IE6, IE7, Opera9, Opera10, Safari3.1, Chrome\n\n    *FF = Firefox\n    *IE = Internet Explorer\n\n\n=head1 REQUIRES\n\nbin/po2json requires perl, and the perl modules Locale::PO and JSON.\n\n=head1 SEE ALSO\n\nbin/po2json (included),\nexamples/normal/index.html,\nexamples/wrapper/i18n.html, examples/wrapper/i18n.js,\nLocale::gettext_pp(3pm), POSIX(3pm), gettext(1), gettext(3)\n\n=head1 AUTHOR\n\nCopyright (C) 2008, Joshua I. Miller E<lt>unrtst@cpan.orgE<gt>, all rights reserved. See the source code for details.\n\n=cut\n\n*/\n\n","\n/*\n** Annotator v1.2.9\n** https://github.com/okfn/annotator/\n**\n** Copyright 2013, the Annotator project contributors.\n** Dual licensed under the MIT and GPLv3 licenses.\n** https://github.com/okfn/annotator/blob/master/LICENSE\n**\n** Built at: 2013-12-02 17:58:01Z\n */\n\n\n// Generated by CoffeeScript 1.6.3\n(function() {\n  var $, Annotator, Delegator, LinkParser, Range, Util, base64Decode, base64UrlDecode, createDateFromISO8601, findChild, fn, functions, g, getNodeName, getNodePosition, gettext, parseToken, simpleXPathJQuery, simpleXPathPure, _Annotator, _gettext, _i, _j, _len, _len1, _ref, _ref1, _t,\n    __slice = [].slice,\n    __hasProp = {}.hasOwnProperty,\n    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },\n    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };\n\n  simpleXPathJQuery = function(relativeRoot) {\n    var jq;\n    jq = this.map(function() {\n      var elem, idx, path, tagName;\n      path = '';\n      elem = this;\n      while ((elem != null ? elem.nodeType : void 0) === Node.ELEMENT_NODE && elem !== relativeRoot) {\n        tagName = elem.tagName.replace(\":\", \"\\\\:\");\n        idx = $(elem.parentNode).children(tagName).index(elem) + 1;\n        idx = \"[\" + idx + \"]\";\n        path = \"/\" + elem.tagName.toLowerCase() + idx + path;\n        elem = elem.parentNode;\n      }\n      return path;\n    });\n    return jq.get();\n  };\n\n  simpleXPathPure = function(relativeRoot) {\n    var getPathSegment, getPathTo, jq, rootNode;\n    getPathSegment = function(node) {\n      var name, pos;\n      name = getNodeName(node);\n      pos = getNodePosition(node);\n      return \"\" + name + \"[\" + pos + \"]\";\n    };\n    rootNode = relativeRoot;\n    getPathTo = function(node) {\n      var xpath;\n      xpath = '';\n      while (node !== rootNode) {\n        if (node == null) {\n          throw new Error(\"Called getPathTo on a node which was not a descendant of @rootNode. \" + rootNode);\n        }\n        xpath = (getPathSegment(node)) + '/' + xpath;\n        node = node.parentNode;\n      }\n      xpath = '/' + xpath;\n      xpath = xpath.replace(/\\/$/, '');\n      return xpath;\n    };\n    jq = this.map(function() {\n      var path;\n      path = getPathTo(this);\n      return path;\n    });\n    return jq.get();\n  };\n\n  findChild = function(node, type, index) {\n    var child, children, found, name, _i, _len;\n    if (!node.hasChildNodes()) {\n      throw new Error(\"XPath error: node has no children!\");\n    }\n    children = node.childNodes;\n    found = 0;\n    for (_i = 0, _len = children.length; _i < _len; _i++) {\n      child = children[_i];\n      name = getNodeName(child);\n      if (name === type) {\n        found += 1;\n        if (found === index) {\n          return child;\n        }\n      }\n    }\n    throw new Error(\"XPath error: wanted child not found.\");\n  };\n\n  getNodeName = function(node) {\n    var nodeName;\n    nodeName = node.nodeName.toLowerCase();\n    switch (nodeName) {\n      case \"#text\":\n        return \"text()\";\n      case \"#comment\":\n        return \"comment()\";\n      case \"#cdata-section\":\n        return \"cdata-section()\";\n      default:\n        return nodeName;\n    }\n  };\n\n  getNodePosition = function(node) {\n    var pos, tmp;\n    pos = 0;\n    tmp = node;\n    while (tmp) {\n      if (tmp.nodeName === node.nodeName) {\n        pos++;\n      }\n      tmp = tmp.previousSibling;\n    }\n    return pos;\n  };\n\n  gettext = null;\n\n  if (typeof Gettext !== \"undefined\" && Gettext !== null) {\n    _gettext = new Gettext({\n      domain: \"annotator\"\n    });\n    gettext = function(msgid) {\n      return _gettext.gettext(msgid);\n    };\n  } else {\n    gettext = function(msgid) {\n      return msgid;\n    };\n  }\n\n  _t = function(msgid) {\n    return gettext(msgid);\n  };\n\n  if (!(typeof jQuery !== \"undefined\" && jQuery !== null ? (_ref = jQuery.fn) != null ? _ref.jquery : void 0 : void 0)) {\n    console.error(_t(\"Annotator requires jQuery: have you included lib/vendor/jquery.js?\"));\n  }\n\n  if (!(JSON && JSON.parse && JSON.stringify)) {\n    console.error(_t(\"Annotator requires a JSON implementation: have you included lib/vendor/json2.js?\"));\n  }\n\n  $ = jQuery;\n\n  Util = {};\n\n  Util.flatten = function(array) {\n    var flatten;\n    flatten = function(ary) {\n      var el, flat, _i, _len;\n      flat = [];\n      for (_i = 0, _len = ary.length; _i < _len; _i++) {\n        el = ary[_i];\n        flat = flat.concat(el && $.isArray(el) ? flatten(el) : el);\n      }\n      return flat;\n    };\n    return flatten(array);\n  };\n\n  Util.contains = function(parent, child) {\n    var node;\n    node = child;\n    while (node != null) {\n      if (node === parent) {\n        return true;\n      }\n      node = node.parentNode;\n    }\n    return false;\n  };\n\n  Util.getTextNodes = function(jq) {\n    var getTextNodes;\n    getTextNodes = function(node) {\n      var nodes;\n      if (node && node.nodeType !== Node.TEXT_NODE) {\n        nodes = [];\n        if (node.nodeType !== Node.COMMENT_NODE) {\n          node = node.lastChild;\n          while (node) {\n            nodes.push(getTextNodes(node));\n            node = node.previousSibling;\n          }\n        }\n        return nodes.reverse();\n      } else {\n        return node;\n      }\n    };\n    return jq.map(function() {\n      return Util.flatten(getTextNodes(this));\n    });\n  };\n\n  Util.getLastTextNodeUpTo = function(n) {\n    var result;\n    switch (n.nodeType) {\n      case Node.TEXT_NODE:\n        return n;\n      case Node.ELEMENT_NODE:\n        if (n.lastChild != null) {\n          result = Util.getLastTextNodeUpTo(n.lastChild);\n          if (result != null) {\n            return result;\n          }\n        }\n        break;\n    }\n    n = n.previousSibling;\n    if (n != null) {\n      return Util.getLastTextNodeUpTo(n);\n    } else {\n      return null;\n    }\n  };\n\n  Util.getFirstTextNodeNotBefore = function(n) {\n    var result;\n    switch (n.nodeType) {\n      case Node.TEXT_NODE:\n        return n;\n      case Node.ELEMENT_NODE:\n        if (n.firstChild != null) {\n          result = Util.getFirstTextNodeNotBefore(n.firstChild);\n          if (result != null) {\n            return result;\n          }\n        }\n        break;\n    }\n    n = n.nextSibling;\n    if (n != null) {\n      return Util.getFirstTextNodeNotBefore(n);\n    } else {\n      return null;\n    }\n  };\n\n  Util.readRangeViaSelection = function(range) {\n    var sel;\n    sel = Util.getGlobal().getSelection();\n    sel.removeAllRanges();\n    sel.addRange(range.toRange());\n    return sel.toString();\n  };\n\n  Util.xpathFromNode = function(el, relativeRoot) {\n    var exception, result;\n    try {\n      result = simpleXPathJQuery.call(el, relativeRoot);\n    } catch (_error) {\n      exception = _error;\n      console.log(\"jQuery-based XPath construction failed! Falling back to manual.\");\n      result = simpleXPathPure.call(el, relativeRoot);\n    }\n    return result;\n  };\n\n  Util.nodeFromXPath = function(xp, root) {\n    var idx, name, node, step, steps, _i, _len, _ref1;\n    steps = xp.substring(1).split(\"/\");\n    node = root;\n    for (_i = 0, _len = steps.length; _i < _len; _i++) {\n      step = steps[_i];\n      _ref1 = step.split(\"[\"), name = _ref1[0], idx = _ref1[1];\n      idx = idx != null ? parseInt((idx != null ? idx.split(\"]\") : void 0)[0]) : 1;\n      node = findChild(node, name.toLowerCase(), idx);\n    }\n    return node;\n  };\n\n  Util.escape = function(html) {\n    return html.replace(/&(?!\\w+;)/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n  };\n\n  Util.uuid = (function() {\n    var counter;\n    counter = 0;\n    return function() {\n      return counter++;\n    };\n  })();\n\n  Util.getGlobal = function() {\n    return (function() {\n      return this;\n    })();\n  };\n\n  Util.maxZIndex = function($elements) {\n    var all, el;\n    all = (function() {\n      var _i, _len, _results;\n      _results = [];\n      for (_i = 0, _len = $elements.length; _i < _len; _i++) {\n        el = $elements[_i];\n        if ($(el).css('position') === 'static') {\n          _results.push(-1);\n        } else {\n          _results.push(parseInt($(el).css('z-index'), 10) || -1);\n        }\n      }\n      return _results;\n    })();\n    return Math.max.apply(Math, all);\n  };\n\n  Util.mousePosition = function(e, offsetEl) {\n    var offset, _ref1;\n    if ((_ref1 = $(offsetEl).css('position')) !== 'absolute' && _ref1 !== 'fixed' && _ref1 !== 'relative') {\n      offsetEl = $(offsetEl).offsetParent()[0];\n    }\n    offset = $(offsetEl).offset();\n    return {\n      top: e.pageY - offset.top,\n      left: e.pageX - offset.left\n    };\n  };\n\n  Util.preventEventDefault = function(event) {\n    return event != null ? typeof event.preventDefault === \"function\" ? event.preventDefault() : void 0 : void 0;\n  };\n\n  functions = [\"log\", \"debug\", \"info\", \"warn\", \"exception\", \"assert\", \"dir\", \"dirxml\", \"trace\", \"group\", \"groupEnd\", \"groupCollapsed\", \"time\", \"timeEnd\", \"profile\", \"profileEnd\", \"count\", \"clear\", \"table\", \"error\", \"notifyFirebug\", \"firebug\", \"userObjects\"];\n\n  if (typeof console !== \"undefined\" && console !== null) {\n    if (console.group == null) {\n      console.group = function(name) {\n        return console.log(\"GROUP: \", name);\n      };\n    }\n    if (console.groupCollapsed == null) {\n      console.groupCollapsed = console.group;\n    }\n    for (_i = 0, _len = functions.length; _i < _len; _i++) {\n      fn = functions[_i];\n      if (console[fn] == null) {\n        console[fn] = function() {\n          return console.log(_t(\"Not implemented:\") + (\" console.\" + name));\n        };\n      }\n    }\n  } else {\n    this.console = {};\n    for (_j = 0, _len1 = functions.length; _j < _len1; _j++) {\n      fn = functions[_j];\n      this.console[fn] = function() {};\n    }\n    this.console['error'] = function() {\n      var args;\n      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];\n      return alert(\"ERROR: \" + (args.join(', ')));\n    };\n    this.console['warn'] = function() {\n      var args;\n      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];\n      return alert(\"WARNING: \" + (args.join(', ')));\n    };\n  }\n\n  Delegator = (function() {\n    Delegator.prototype.events = {};\n\n    Delegator.prototype.options = {};\n\n    Delegator.prototype.element = null;\n\n    function Delegator(element, options) {\n      this.options = $.extend(true, {}, this.options, options);\n      this.element = $(element);\n      this._closures = {};\n      this.on = this.subscribe;\n      this.addEvents();\n    }\n\n    Delegator.prototype.addEvents = function() {\n      var event, _k, _len2, _ref1, _results;\n      _ref1 = Delegator._parseEvents(this.events);\n      _results = [];\n      for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n        event = _ref1[_k];\n        _results.push(this._addEvent(event.selector, event.event, event.functionName));\n      }\n      return _results;\n    };\n\n    Delegator.prototype.removeEvents = function() {\n      var event, _k, _len2, _ref1, _results;\n      _ref1 = Delegator._parseEvents(this.events);\n      _results = [];\n      for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n        event = _ref1[_k];\n        _results.push(this._removeEvent(event.selector, event.event, event.functionName));\n      }\n      return _results;\n    };\n\n    Delegator.prototype._addEvent = function(selector, event, functionName) {\n      var closure;\n      closure = (function(_this) {\n        return function() {\n          return _this[functionName].apply(_this, arguments);\n        };\n      })(this);\n      if (selector === '' && Delegator._isCustomEvent(event)) {\n        this.subscribe(event, closure);\n      } else {\n        this.element.delegate(selector, event, closure);\n      }\n      this._closures[\"\" + selector + \"/\" + event + \"/\" + functionName] = closure;\n      return this;\n    };\n\n    Delegator.prototype._removeEvent = function(selector, event, functionName) {\n      var closure;\n      closure = this._closures[\"\" + selector + \"/\" + event + \"/\" + functionName];\n      if (selector === '' && Delegator._isCustomEvent(event)) {\n        this.unsubscribe(event, closure);\n      } else {\n        this.element.undelegate(selector, event, closure);\n      }\n      delete this._closures[\"\" + selector + \"/\" + event + \"/\" + functionName];\n      return this;\n    };\n\n    Delegator.prototype.publish = function() {\n      this.element.triggerHandler.apply(this.element, arguments);\n      return this;\n    };\n\n    Delegator.prototype.subscribe = function(event, callback) {\n      var closure;\n      closure = function() {\n        return callback.apply(this, [].slice.call(arguments, 1));\n      };\n      closure.guid = callback.guid = ($.guid += 1);\n      this.element.bind(event, closure);\n      return this;\n    };\n\n    Delegator.prototype.unsubscribe = function() {\n      this.element.unbind.apply(this.element, arguments);\n      return this;\n    };\n\n    return Delegator;\n\n  })();\n\n  Delegator._parseEvents = function(eventsObj) {\n    var event, events, functionName, sel, selector, _k, _ref1;\n    events = [];\n    for (sel in eventsObj) {\n      functionName = eventsObj[sel];\n      _ref1 = sel.split(' '), selector = 2 <= _ref1.length ? __slice.call(_ref1, 0, _k = _ref1.length - 1) : (_k = 0, []), event = _ref1[_k++];\n      events.push({\n        selector: selector.join(' '),\n        event: event,\n        functionName: functionName\n      });\n    }\n    return events;\n  };\n\n  Delegator.natives = (function() {\n    var key, specials, val;\n    specials = (function() {\n      var _ref1, _results;\n      _ref1 = jQuery.event.special;\n      _results = [];\n      for (key in _ref1) {\n        if (!__hasProp.call(_ref1, key)) continue;\n        val = _ref1[key];\n        _results.push(key);\n      }\n      return _results;\n    })();\n    return \"blur focus focusin focusout load resize scroll unload click dblclick\\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\\nchange select submit keydown keypress keyup error\".split(/[^a-z]+/).concat(specials);\n  })();\n\n  Delegator._isCustomEvent = function(event) {\n    event = event.split('.')[0];\n    return $.inArray(event, Delegator.natives) === -1;\n  };\n\n  Range = {};\n\n  Range.sniff = function(r) {\n    if (r.commonAncestorContainer != null) {\n      return new Range.BrowserRange(r);\n    } else if (typeof r.start === \"string\") {\n      return new Range.SerializedRange(r);\n    } else if (r.start && typeof r.start === \"object\") {\n      return new Range.NormalizedRange(r);\n    } else {\n      console.error(_t(\"Could not sniff range type\"));\n      return false;\n    }\n  };\n\n  Range.nodeFromXPath = function(xpath, root) {\n    var customResolver, evaluateXPath, namespace, node, segment;\n    if (root == null) {\n      root = document;\n    }\n    evaluateXPath = function(xp, nsResolver) {\n      var exception;\n      if (nsResolver == null) {\n        nsResolver = null;\n      }\n      try {\n        return document.evaluate('.' + xp, root, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;\n      } catch (_error) {\n        exception = _error;\n        console.log(\"XPath evaluation failed.\");\n        console.log(\"Trying fallback...\");\n        return Util.nodeFromXPath(xp, root);\n      }\n    };\n    if (!$.isXMLDoc(document.documentElement)) {\n      return evaluateXPath(xpath);\n    } else {\n      customResolver = document.createNSResolver(document.ownerDocument === null ? document.documentElement : document.ownerDocument.documentElement);\n      node = evaluateXPath(xpath, customResolver);\n      if (!node) {\n        xpath = ((function() {\n          var _k, _len2, _ref1, _results;\n          _ref1 = xpath.split('/');\n          _results = [];\n          for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n            segment = _ref1[_k];\n            if (segment && segment.indexOf(':') === -1) {\n              _results.push(segment.replace(/^([a-z]+)/, 'xhtml:$1'));\n            } else {\n              _results.push(segment);\n            }\n          }\n          return _results;\n        })()).join('/');\n        namespace = document.lookupNamespaceURI(null);\n        customResolver = function(ns) {\n          if (ns === 'xhtml') {\n            return namespace;\n          } else {\n            return document.documentElement.getAttribute('xmlns:' + ns);\n          }\n        };\n        node = evaluateXPath(xpath, customResolver);\n      }\n      return node;\n    }\n  };\n\n  Range.RangeError = (function(_super) {\n    __extends(RangeError, _super);\n\n    function RangeError(type, message, parent) {\n      this.type = type;\n      this.message = message;\n      this.parent = parent != null ? parent : null;\n      RangeError.__super__.constructor.call(this, this.message);\n    }\n\n    return RangeError;\n\n  })(Error);\n\n  Range.BrowserRange = (function() {\n    function BrowserRange(obj) {\n      this.commonAncestorContainer = obj.commonAncestorContainer;\n      this.startContainer = obj.startContainer;\n      this.startOffset = obj.startOffset;\n      this.endContainer = obj.endContainer;\n      this.endOffset = obj.endOffset;\n    }\n\n    BrowserRange.prototype.normalize = function(root) {\n      var n, node, nr, r;\n      if (this.tainted) {\n        console.error(_t(\"You may only call normalize() once on a BrowserRange!\"));\n        return false;\n      } else {\n        this.tainted = true;\n      }\n      r = {};\n      if (this.startContainer.nodeType === Node.ELEMENT_NODE) {\n        r.start = Util.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]);\n        r.startOffset = 0;\n      } else {\n        r.start = this.startContainer;\n        r.startOffset = this.startOffset;\n      }\n      if (this.endContainer.nodeType === Node.ELEMENT_NODE) {\n        node = this.endContainer.childNodes[this.endOffset];\n        if (node != null) {\n          n = node;\n          while ((n != null) && (n.nodeType !== Node.TEXT_NODE)) {\n            n = n.firstChild;\n          }\n          if (n != null) {\n            r.end = n;\n            r.endOffset = 0;\n          }\n        }\n        if (r.end == null) {\n          node = this.endContainer.childNodes[this.endOffset - 1];\n          r.end = Util.getLastTextNodeUpTo(node);\n          r.endOffset = r.end.nodeValue.length;\n        }\n      } else {\n        r.end = this.endContainer;\n        r.endOffset = this.endOffset;\n      }\n      nr = {};\n      if (r.startOffset > 0) {\n        if (r.start.nodeValue.length > r.startOffset) {\n          nr.start = r.start.splitText(r.startOffset);\n        } else {\n          nr.start = r.start.nextSibling;\n        }\n      } else {\n        nr.start = r.start;\n      }\n      if (r.start === r.end) {\n        if (nr.start.nodeValue.length > (r.endOffset - r.startOffset)) {\n          nr.start.splitText(r.endOffset - r.startOffset);\n        }\n        nr.end = nr.start;\n      } else {\n        if (r.end.nodeValue.length > r.endOffset) {\n          r.end.splitText(r.endOffset);\n        }\n        nr.end = r.end;\n      }\n      nr.commonAncestor = this.commonAncestorContainer;\n      while (nr.commonAncestor.nodeType !== Node.ELEMENT_NODE) {\n        nr.commonAncestor = nr.commonAncestor.parentNode;\n      }\n      return new Range.NormalizedRange(nr);\n    };\n\n    BrowserRange.prototype.serialize = function(root, ignoreSelector) {\n      return this.normalize(root).serialize(root, ignoreSelector);\n    };\n\n    return BrowserRange;\n\n  })();\n\n  Range.NormalizedRange = (function() {\n    function NormalizedRange(obj) {\n      this.commonAncestor = obj.commonAncestor;\n      this.start = obj.start;\n      this.end = obj.end;\n    }\n\n    NormalizedRange.prototype.normalize = function(root) {\n      return this;\n    };\n\n    NormalizedRange.prototype.limit = function(bounds) {\n      var nodes, parent, startParents, _k, _len2, _ref1;\n      nodes = $.grep(this.textNodes(), function(node) {\n        return node.parentNode === bounds || $.contains(bounds, node.parentNode);\n      });\n      if (!nodes.length) {\n        return null;\n      }\n      this.start = nodes[0];\n      this.end = nodes[nodes.length - 1];\n      startParents = $(this.start).parents();\n      _ref1 = $(this.end).parents();\n      for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n        parent = _ref1[_k];\n        if (startParents.index(parent) !== -1) {\n          this.commonAncestor = parent;\n          break;\n        }\n      }\n      return this;\n    };\n\n    NormalizedRange.prototype.serialize = function(root, ignoreSelector) {\n      var end, serialization, start;\n      serialization = function(node, isEnd) {\n        var n, nodes, offset, origParent, textNodes, xpath, _k, _len2;\n        if (ignoreSelector) {\n          origParent = $(node).parents(\":not(\" + ignoreSelector + \")\").eq(0);\n        } else {\n          origParent = $(node).parent();\n        }\n        xpath = Util.xpathFromNode(origParent, root)[0];\n        textNodes = Util.getTextNodes(origParent);\n        nodes = textNodes.slice(0, textNodes.index(node));\n        offset = 0;\n        for (_k = 0, _len2 = nodes.length; _k < _len2; _k++) {\n          n = nodes[_k];\n          offset += n.nodeValue.length;\n        }\n        if (isEnd) {\n          return [xpath, offset + node.nodeValue.length];\n        } else {\n          return [xpath, offset];\n        }\n      };\n      start = serialization(this.start);\n      end = serialization(this.end, true);\n      return new Range.SerializedRange({\n        start: start[0],\n        end: end[0],\n        startOffset: start[1],\n        endOffset: end[1]\n      });\n    };\n\n    NormalizedRange.prototype.text = function() {\n      var node;\n      return ((function() {\n        var _k, _len2, _ref1, _results;\n        _ref1 = this.textNodes();\n        _results = [];\n        for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n          node = _ref1[_k];\n          _results.push(node.nodeValue);\n        }\n        return _results;\n      }).call(this)).join('');\n    };\n\n    NormalizedRange.prototype.textNodes = function() {\n      var end, start, textNodes, _ref1;\n      textNodes = Util.getTextNodes($(this.commonAncestor));\n      _ref1 = [textNodes.index(this.start), textNodes.index(this.end)], start = _ref1[0], end = _ref1[1];\n      return $.makeArray(textNodes.slice(start, +end + 1 || 9e9));\n    };\n\n    NormalizedRange.prototype.toRange = function() {\n      var range;\n      range = document.createRange();\n      range.setStartBefore(this.start);\n      range.setEndAfter(this.end);\n      return range;\n    };\n\n    return NormalizedRange;\n\n  })();\n\n  Range.SerializedRange = (function() {\n    function SerializedRange(obj) {\n      this.start = obj.start;\n      this.startOffset = obj.startOffset;\n      this.end = obj.end;\n      this.endOffset = obj.endOffset;\n    }\n\n    SerializedRange.prototype.normalize = function(root) {\n      var contains, e, length, node, p, range, targetOffset, tn, _k, _l, _len2, _len3, _ref1, _ref2;\n      range = {};\n      _ref1 = ['start', 'end'];\n      for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n        p = _ref1[_k];\n        try {\n          node = Range.nodeFromXPath(this[p], root);\n        } catch (_error) {\n          e = _error;\n          throw new Range.RangeError(p, (\"Error while finding \" + p + \" node: \" + this[p] + \": \") + e, e);\n        }\n        if (!node) {\n          throw new Range.RangeError(p, \"Couldn't find \" + p + \" node: \" + this[p]);\n        }\n        length = 0;\n        targetOffset = this[p + 'Offset'];\n        if (p === 'end') {\n          targetOffset--;\n        }\n        _ref2 = Util.getTextNodes($(node));\n        for (_l = 0, _len3 = _ref2.length; _l < _len3; _l++) {\n          tn = _ref2[_l];\n          if (length + tn.nodeValue.length > targetOffset) {\n            range[p + 'Container'] = tn;\n            range[p + 'Offset'] = this[p + 'Offset'] - length;\n            break;\n          } else {\n            length += tn.nodeValue.length;\n          }\n        }\n        if (range[p + 'Offset'] == null) {\n          throw new Range.RangeError(\"\" + p + \"offset\", \"Couldn't find offset \" + this[p + 'Offset'] + \" in element \" + this[p]);\n        }\n      }\n      contains = document.compareDocumentPosition == null ? function(a, b) {\n        return a.contains(b);\n      } : function(a, b) {\n        return a.compareDocumentPosition(b) & 16;\n      };\n      $(range.startContainer).parents().each(function() {\n        if (contains(this, range.endContainer)) {\n          range.commonAncestorContainer = this;\n          return false;\n        }\n      });\n      return new Range.BrowserRange(range).normalize(root);\n    };\n\n    SerializedRange.prototype.serialize = function(root, ignoreSelector) {\n      return this.normalize(root).serialize(root, ignoreSelector);\n    };\n\n    SerializedRange.prototype.toObject = function() {\n      return {\n        start: this.start,\n        startOffset: this.startOffset,\n        end: this.end,\n        endOffset: this.endOffset\n      };\n    };\n\n    return SerializedRange;\n\n  })();\n\n  _Annotator = this.Annotator;\n\n  Annotator = (function(_super) {\n    __extends(Annotator, _super);\n\n    Annotator.prototype.events = {\n      \".annotator-adder button click\": \"onAdderClick\",\n      \".annotator-adder button mousedown\": \"onAdderMousedown\",\n      \".annotator-hl mouseover\": \"onHighlightMouseover\",\n      \".annotator-hl mouseout\": \"startViewerHideTimer\"\n    };\n\n    Annotator.prototype.html = {\n      adder: '<div class=\"annotator-adder\"><button>' + _t('Annotate') + '</button></div>',\n      wrapper: '<div class=\"annotator-wrapper\"></div>'\n    };\n\n    Annotator.prototype.options = {\n      readOnly: false\n    };\n\n    Annotator.prototype.plugins = {};\n\n    Annotator.prototype.editor = null;\n\n    Annotator.prototype.viewer = null;\n\n    Annotator.prototype.selectedRanges = null;\n\n    Annotator.prototype.mouseIsDown = false;\n\n    Annotator.prototype.ignoreMouseup = false;\n\n    Annotator.prototype.viewerHideTimer = null;\n\n    function Annotator(element, options) {\n      this.onDeleteAnnotation = __bind(this.onDeleteAnnotation, this);\n      this.onEditAnnotation = __bind(this.onEditAnnotation, this);\n      this.onAdderClick = __bind(this.onAdderClick, this);\n      this.onAdderMousedown = __bind(this.onAdderMousedown, this);\n      this.onHighlightMouseover = __bind(this.onHighlightMouseover, this);\n      this.checkForEndSelection = __bind(this.checkForEndSelection, this);\n      this.checkForStartSelection = __bind(this.checkForStartSelection, this);\n      this.clearViewerHideTimer = __bind(this.clearViewerHideTimer, this);\n      this.startViewerHideTimer = __bind(this.startViewerHideTimer, this);\n      this.showViewer = __bind(this.showViewer, this);\n      this.onEditorSubmit = __bind(this.onEditorSubmit, this);\n      this.onEditorHide = __bind(this.onEditorHide, this);\n      this.showEditor = __bind(this.showEditor, this);\n      Annotator.__super__.constructor.apply(this, arguments);\n      this.plugins = {};\n      if (!Annotator.supported()) {\n        return this;\n      }\n      if (!this.options.readOnly) {\n        this._setupDocumentEvents();\n      }\n      this._setupWrapper()._setupViewer()._setupEditor();\n      this._setupDynamicStyle();\n      this.adder = $(this.html.adder).appendTo(this.wrapper).hide();\n      Annotator._instances.push(this);\n    }\n\n    Annotator.prototype._setupWrapper = function() {\n      this.wrapper = $(this.html.wrapper);\n      this.element.find('script').remove();\n      this.element.wrapInner(this.wrapper);\n      this.wrapper = this.element.find('.annotator-wrapper');\n      return this;\n    };\n\n    Annotator.prototype._setupViewer = function() {\n      this.viewer = new Annotator.Viewer({\n        readOnly: this.options.readOnly\n      });\n      this.viewer.hide().on(\"edit\", this.onEditAnnotation).on(\"delete\", this.onDeleteAnnotation).addField({\n        load: (function(_this) {\n          return function(field, annotation) {\n            if (annotation.text) {\n              $(field).html(Util.escape(annotation.text));\n            } else {\n              $(field).html(\"<i>\" + (_t('No Comment')) + \"</i>\");\n            }\n            return _this.publish('annotationViewerTextField', [field, annotation]);\n          };\n        })(this)\n      }).element.appendTo(this.wrapper).bind({\n        \"mouseover\": this.clearViewerHideTimer,\n        \"mouseout\": this.startViewerHideTimer\n      });\n      return this;\n    };\n\n    Annotator.prototype._setupEditor = function() {\n      this.editor = new Annotator.Editor();\n      this.editor.hide().on('hide', this.onEditorHide).on('save', this.onEditorSubmit).addField({\n        type: 'textarea',\n        label: _t('Comments') + '\\u2026',\n        load: function(field, annotation) {\n          return $(field).find('textarea').val(annotation.text || '');\n        },\n        submit: function(field, annotation) {\n          return annotation.text = $(field).find('textarea').val();\n        }\n      });\n      this.editor.element.appendTo(this.wrapper);\n      return this;\n    };\n\n    Annotator.prototype._setupDocumentEvents = function() {\n      $(document).bind({\n        \"mouseup\": this.checkForEndSelection,\n        \"mousedown\": this.checkForStartSelection\n      });\n      return this;\n    };\n\n    Annotator.prototype._setupDynamicStyle = function() {\n      var max, sel, style, x;\n      style = $('#annotator-dynamic-style');\n      if (!style.length) {\n        style = $('<style id=\"annotator-dynamic-style\"></style>').appendTo(document.head);\n      }\n      sel = '*' + ((function() {\n        var _k, _len2, _ref1, _results;\n        _ref1 = ['adder', 'outer', 'notice', 'filter'];\n        _results = [];\n        for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n          x = _ref1[_k];\n          _results.push(\":not(.annotator-\" + x + \")\");\n        }\n        return _results;\n      })()).join('');\n      max = Util.maxZIndex($(document.body).find(sel));\n      max = Math.max(max, 1000);\n      style.text([\".annotator-adder, .annotator-outer, .annotator-notice {\", \"  z-index: \" + (max + 20) + \";\", \"}\", \".annotator-filter {\", \"  z-index: \" + (max + 10) + \";\", \"}\"].join(\"\\n\"));\n      return this;\n    };\n\n    Annotator.prototype.destroy = function() {\n      var idx, name, plugin, _ref1;\n      $(document).unbind({\n        \"mouseup\": this.checkForEndSelection,\n        \"mousedown\": this.checkForStartSelection\n      });\n      $('#annotator-dynamic-style').remove();\n      this.adder.remove();\n      this.viewer.destroy();\n      this.editor.destroy();\n      this.wrapper.find('.annotator-hl').each(function() {\n        $(this).contents().insertBefore(this);\n        return $(this).remove();\n      });\n      this.wrapper.contents().insertBefore(this.wrapper);\n      this.wrapper.remove();\n      this.element.data('annotator', null);\n      _ref1 = this.plugins;\n      for (name in _ref1) {\n        plugin = _ref1[name];\n        this.plugins[name].destroy();\n      }\n      this.removeEvents();\n      idx = Annotator._instances.indexOf(this);\n      if (idx !== -1) {\n        return Annotator._instances.splice(idx, 1);\n      }\n    };\n\n    Annotator.prototype.getSelectedRanges = function() {\n      var browserRange, i, normedRange, r, ranges, rangesToIgnore, selection, _k, _len2;\n      selection = Util.getGlobal().getSelection();\n      ranges = [];\n      rangesToIgnore = [];\n      if (!selection.isCollapsed) {\n        ranges = (function() {\n          var _k, _ref1, _results;\n          _results = [];\n          for (i = _k = 0, _ref1 = selection.rangeCount; 0 <= _ref1 ? _k < _ref1 : _k > _ref1; i = 0 <= _ref1 ? ++_k : --_k) {\n            r = selection.getRangeAt(i);\n            browserRange = new Range.BrowserRange(r);\n            normedRange = browserRange.normalize().limit(this.wrapper[0]);\n            if (normedRange === null) {\n              rangesToIgnore.push(r);\n            }\n            _results.push(normedRange);\n          }\n          return _results;\n        }).call(this);\n        selection.removeAllRanges();\n      }\n      for (_k = 0, _len2 = rangesToIgnore.length; _k < _len2; _k++) {\n        r = rangesToIgnore[_k];\n        selection.addRange(r);\n      }\n      return $.grep(ranges, function(range) {\n        if (range) {\n          selection.addRange(range.toRange());\n        }\n        return range;\n      });\n    };\n\n    Annotator.prototype.createAnnotation = function() {\n      var annotation;\n      annotation = {};\n      this.publish('beforeAnnotationCreated', [annotation]);\n      return annotation;\n    };\n\n    Annotator.prototype.setupAnnotation = function(annotation) {\n      var e, normed, normedRanges, r, root, _k, _l, _len2, _len3, _ref1;\n      root = this.wrapper[0];\n      annotation.ranges || (annotation.ranges = this.selectedRanges);\n      normedRanges = [];\n      _ref1 = annotation.ranges;\n      if( _ref1 != null ) {\n          for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n              r = _ref1[_k];\n              try {\n                  normedRanges.push(Range.sniff(r).normalize(root));\n              } catch (_error) {\n                  e = _error;\n                  if (e instanceof Range.RangeError) {\n                      this.publish('rangeNormalizeFail', [annotation, r, e]);\n                  } else {\n                      throw e;\n                  }\n              }\n          }\n      }\n      annotation.quote = [];\n      annotation.ranges = [];\n      annotation.highlights = [];\n      for (_l = 0, _len3 = normedRanges.length; _l < _len3; _l++) {\n        normed = normedRanges[_l];\n        annotation.quote.push($.trim(normed.text()));\n        annotation.ranges.push(normed.serialize(this.wrapper[0], '.annotator-hl'));\n        $.merge(annotation.highlights, this.highlightRange(normed));\n      }\n      annotation.quote = annotation.quote.join(' / ');\n      $(annotation.highlights).data('annotation', annotation);\n      return annotation;\n    };\n\n    Annotator.prototype.updateAnnotation = function(annotation) {\n      this.publish('beforeAnnotationUpdated', [annotation]);\n      this.publish('annotationUpdated', [annotation]);\n      return annotation;\n    };\n\n    Annotator.prototype.deleteAnnotation = function(annotation) {\n      var child, h, _k, _len2, _ref1;\n      if (annotation.highlights != null) {\n        _ref1 = annotation.highlights;\n        for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n          h = _ref1[_k];\n          if (!(h.parentNode != null)) {\n            continue;\n          }\n          child = h.childNodes[0];\n          $(h).replaceWith(h.childNodes);\n        }\n      }\n      this.publish('annotationDeleted', [annotation]);\n      return annotation;\n    };\n\n    Annotator.prototype.loadAnnotations = function(annotations) {\n      var clone, loader;\n      if (annotations == null) {\n        annotations = [];\n      }\n      loader = (function(_this) {\n        return function(annList) {\n          var n, now, _k, _len2;\n          if (annList == null) {\n            annList = [];\n          }\n          now = annList.splice(0, 10);\n          for (_k = 0, _len2 = now.length; _k < _len2; _k++) {\n            n = now[_k];\n            _this.setupAnnotation(n);\n          }\n          if (annList.length > 0) {\n            return setTimeout((function() {\n              return loader(annList);\n            }), 10);\n          } else {\n            return _this.publish('annotationsLoaded', [clone]);\n          }\n        };\n      })(this);\n      clone = annotations.slice();\n      loader(annotations);\n      return this;\n    };\n\n    Annotator.prototype.dumpAnnotations = function() {\n      if (this.plugins['Store']) {\n        return this.plugins['Store'].dumpAnnotations();\n      } else {\n        console.warn(_t(\"Can't dump annotations without Store plugin.\"));\n        return false;\n      }\n    };\n\n    Annotator.prototype.highlightRange = function(normedRange, cssClass) {\n      var hl, node, white, _k, _len2, _ref1, _results;\n      if (cssClass == null) {\n        cssClass = 'annotator-hl';\n      }\n      white = /^\\s*$/;\n      hl = $(\"<span class='\" + cssClass + \"'></span>\");\n      _ref1 = normedRange.textNodes();\n      _results = [];\n      for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n        node = _ref1[_k];\n        if (!white.test(node.nodeValue)) {\n          _results.push($(node).wrapAll(hl).parent().show()[0]);\n        }\n      }\n      return _results;\n    };\n\n    Annotator.prototype.highlightRanges = function(normedRanges, cssClass) {\n      var highlights, r, _k, _len2;\n      if (cssClass == null) {\n        cssClass = 'annotator-hl';\n      }\n      highlights = [];\n      for (_k = 0, _len2 = normedRanges.length; _k < _len2; _k++) {\n        r = normedRanges[_k];\n        $.merge(highlights, this.highlightRange(r, cssClass));\n      }\n      return highlights;\n    };\n\n    Annotator.prototype.addPlugin = function(name, options) {\n      var klass, _base;\n      if (this.plugins[name]) {\n        console.error(_t(\"You cannot have more than one instance of any plugin.\"));\n      } else {\n        klass = Annotator.Plugin[name];\n        if (typeof klass === 'function') {\n          this.plugins[name] = new klass(this.element[0], options);\n          this.plugins[name].annotator = this;\n          if (typeof (_base = this.plugins[name]).pluginInit === \"function\") {\n            _base.pluginInit();\n          }\n        } else {\n          console.error(_t(\"Could not load \") + name + _t(\" plugin. Have you included the appropriate <script> tag?\"));\n        }\n      }\n      return this;\n    };\n\n    Annotator.prototype.showEditor = function(annotation, location) {\n      this.editor.element.css(location);\n      this.editor.load(annotation);\n      this.publish('annotationEditorShown', [this.editor, annotation]);\n      return this;\n    };\n\n    Annotator.prototype.onEditorHide = function() {\n      this.publish('annotationEditorHidden', [this.editor]);\n      return this.ignoreMouseup = false;\n    };\n\n    Annotator.prototype.onEditorSubmit = function(annotation) {\n      return this.publish('annotationEditorSubmit', [this.editor, annotation]);\n    };\n\n    Annotator.prototype.showViewer = function(annotations, location) {\n      this.viewer.element.css(location);\n      this.viewer.load(annotations);\n      return this.publish('annotationViewerShown', [this.viewer, annotations]);\n    };\n\n    Annotator.prototype.startViewerHideTimer = function() {\n      if (!this.viewerHideTimer) {\n        return this.viewerHideTimer = setTimeout(this.viewer.hide, 250);\n      }\n    };\n\n    Annotator.prototype.clearViewerHideTimer = function() {\n      clearTimeout(this.viewerHideTimer);\n      return this.viewerHideTimer = false;\n    };\n\n    Annotator.prototype.checkForStartSelection = function(event) {\n      if (!(event && this.isAnnotator(event.target))) {\n        this.startViewerHideTimer();\n      }\n      return this.mouseIsDown = true;\n    };\n\n    Annotator.prototype.checkForEndSelection = function(event) {\n      var container, range, _k, _len2, _ref1;\n      this.mouseIsDown = false;\n      if (this.ignoreMouseup) {\n        return;\n      }\n      this.selectedRanges = this.getSelectedRanges();\n      _ref1 = this.selectedRanges;\n      for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n        range = _ref1[_k];\n        container = range.commonAncestor;\n        if ($(container).hasClass('annotator-hl')) {\n          container = $(container).parents('[class!=annotator-hl]')[0];\n        }\n        if (this.isAnnotator(container)) {\n          return;\n        }\n      }\n      if (event && this.selectedRanges.length) {\n        return this.adder.css(Util.mousePosition(event, this.wrapper[0])).show();\n      } else {\n        return this.adder.hide();\n      }\n    };\n\n    Annotator.prototype.isAnnotator = function(element) {\n      return !!$(element).parents().addBack().filter('[class^=annotator-]').not(this.wrapper).length;\n    };\n\n    Annotator.prototype.onHighlightMouseover = function(event) {\n      var annotations;\n      this.clearViewerHideTimer();\n      if (this.mouseIsDown || this.viewer.isShown()) {\n        return false;\n      }\n      annotations = $(event.target).parents('.annotator-hl').addBack().map(function() {\n        return $(this).data(\"annotation\");\n      });\n      return this.showViewer($.makeArray(annotations), Util.mousePosition(event, this.wrapper[0]));\n    };\n\n    Annotator.prototype.onAdderMousedown = function(event) {\n      if (event != null) {\n        event.preventDefault();\n      }\n      return this.ignoreMouseup = true;\n    };\n\n    Annotator.prototype.onAdderClick = function(event) {\n      var annotation, cancel, cleanup, position, save;\n      if (event != null) {\n        event.preventDefault();\n      }\n      position = this.adder.position();\n      this.adder.hide();\n      annotation = this.setupAnnotation(this.createAnnotation());\n      $(annotation.highlights).addClass('annotator-hl-temporary');\n      save = (function(_this) {\n        return function() {\n          cleanup();\n          $(annotation.highlights).removeClass('annotator-hl-temporary');\n          return _this.publish('annotationCreated', [annotation]);\n        };\n      })(this);\n      cancel = (function(_this) {\n        return function() {\n          cleanup();\n          return _this.deleteAnnotation(annotation);\n        };\n      })(this);\n      cleanup = (function(_this) {\n        return function() {\n          _this.unsubscribe('annotationEditorHidden', cancel);\n          return _this.unsubscribe('annotationEditorSubmit', save);\n        };\n      })(this);\n      this.subscribe('annotationEditorHidden', cancel);\n      this.subscribe('annotationEditorSubmit', save);\n      return this.showEditor(annotation, position);\n    };\n\n    Annotator.prototype.onEditAnnotation = function(annotation) {\n      var cleanup, offset, update;\n      offset = this.viewer.element.position();\n      update = (function(_this) {\n        return function() {\n          cleanup();\n          return _this.updateAnnotation(annotation);\n        };\n      })(this);\n      cleanup = (function(_this) {\n        return function() {\n          _this.unsubscribe('annotationEditorHidden', cleanup);\n          return _this.unsubscribe('annotationEditorSubmit', update);\n        };\n      })(this);\n      this.subscribe('annotationEditorHidden', cleanup);\n      this.subscribe('annotationEditorSubmit', update);\n      this.viewer.hide();\n      return this.showEditor(annotation, offset);\n    };\n\n    Annotator.prototype.onDeleteAnnotation = function(annotation) {\n      this.viewer.hide();\n      return this.deleteAnnotation(annotation);\n    };\n\n    return Annotator;\n\n  })(Delegator);\n\n  Annotator.Plugin = (function(_super) {\n    __extends(Plugin, _super);\n\n    function Plugin(element, options) {\n      Plugin.__super__.constructor.apply(this, arguments);\n    }\n\n    Plugin.prototype.pluginInit = function() {};\n\n    Plugin.prototype.destroy = function() {\n      return this.removeEvents();\n    };\n\n    return Plugin;\n\n  })(Delegator);\n\n  g = Util.getGlobal();\n\n  if (((_ref1 = g.document) != null ? _ref1.evaluate : void 0) == null) {\n    $.getScript('http://assets.annotateit.org/vendor/xpath.min.js');\n  }\n\n  if (g.getSelection == null) {\n    $.getScript('http://assets.annotateit.org/vendor/ierange.min.js');\n  }\n\n  if (g.JSON == null) {\n    $.getScript('http://assets.annotateit.org/vendor/json2.min.js');\n  }\n\n  if (g.Node == null) {\n    g.Node = {\n      ELEMENT_NODE: 1,\n      ATTRIBUTE_NODE: 2,\n      TEXT_NODE: 3,\n      CDATA_SECTION_NODE: 4,\n      ENTITY_REFERENCE_NODE: 5,\n      ENTITY_NODE: 6,\n      PROCESSING_INSTRUCTION_NODE: 7,\n      COMMENT_NODE: 8,\n      DOCUMENT_NODE: 9,\n      DOCUMENT_TYPE_NODE: 10,\n      DOCUMENT_FRAGMENT_NODE: 11,\n      NOTATION_NODE: 12\n    };\n  }\n\n  Annotator.$ = $;\n\n  Annotator.Delegator = Delegator;\n\n  Annotator.Range = Range;\n\n  Annotator.Util = Util;\n\n  Annotator._instances = [];\n\n  Annotator._t = _t;\n\n  Annotator.supported = function() {\n    return (function() {\n      return !!this.getSelection;\n    })();\n  };\n\n  Annotator.noConflict = function() {\n    Util.getGlobal().Annotator = _Annotator;\n    return this;\n  };\n\n  $.fn.annotator = function(options) {\n    var args;\n    args = Array.prototype.slice.call(arguments, 1);\n    return this.each(function() {\n      var instance;\n      instance = $.data(this, 'annotator');\n      if (instance) {\n        return options && instance[options].apply(instance, args);\n      } else {\n        instance = new Annotator(this, options);\n        return $.data(this, 'annotator', instance);\n      }\n    });\n  };\n\n  this.Annotator = Annotator;\n\n  Annotator.Widget = (function(_super) {\n    __extends(Widget, _super);\n\n    Widget.prototype.classes = {\n      hide: 'annotator-hide',\n      invert: {\n        x: 'annotator-invert-x',\n        y: 'annotator-invert-y'\n      }\n    };\n\n    function Widget(element, options) {\n      Widget.__super__.constructor.apply(this, arguments);\n      this.classes = $.extend({}, Annotator.Widget.prototype.classes, this.classes);\n    }\n\n    Widget.prototype.destroy = function() {\n      this.removeEvents();\n      return this.element.remove();\n    };\n\n    Widget.prototype.checkOrientation = function() {\n      var current, offset, viewport, widget, window;\n      this.resetOrientation();\n      window = $(Annotator.Util.getGlobal());\n      widget = this.element.children(\":first\");\n      offset = widget.offset();\n      viewport = {\n        top: window.scrollTop(),\n        right: window.width() + window.scrollLeft()\n      };\n      current = {\n        top: offset.top,\n        right: offset.left + widget.width()\n      };\n      if ((current.top - viewport.top) < 0) {\n        this.invertY();\n      }\n      if ((current.right - viewport.right) > 0) {\n        this.invertX();\n      }\n      return this;\n    };\n\n    Widget.prototype.resetOrientation = function() {\n      this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);\n      return this;\n    };\n\n    Widget.prototype.invertX = function() {\n      this.element.addClass(this.classes.invert.x);\n      return this;\n    };\n\n    Widget.prototype.invertY = function() {\n      this.element.addClass(this.classes.invert.y);\n      return this;\n    };\n\n    Widget.prototype.isInvertedY = function() {\n      return this.element.hasClass(this.classes.invert.y);\n    };\n\n    Widget.prototype.isInvertedX = function() {\n      return this.element.hasClass(this.classes.invert.x);\n    };\n\n    return Widget;\n\n  })(Delegator);\n\n  Annotator.Editor = (function(_super) {\n    __extends(Editor, _super);\n\n    Editor.prototype.events = {\n      \"form submit\": \"submit\",\n      \".annotator-save click\": \"submit\",\n      \".annotator-cancel click\": \"hide\",\n      \".annotator-cancel mouseover\": \"onCancelButtonMouseover\",\n      \"textarea keydown\": \"processKeypress\"\n    };\n\n    Editor.prototype.classes = {\n      hide: 'annotator-hide',\n      focus: 'annotator-focus'\n    };\n\n    Editor.prototype.html = \"<div class=\\\"annotator-outer annotator-editor\\\">\\n  <form class=\\\"annotator-widget\\\">\\n    <ul class=\\\"annotator-listing\\\"></ul>\\n    <div class=\\\"annotator-controls\\\">\\n      <a href=\\\"#cancel\\\" class=\\\"annotator-cancel\\\">\" + _t('Cancel') + \"</a>\\n<a href=\\\"#save\\\" class=\\\"annotator-save annotator-focus\\\">\" + _t('Save') + \"</a>\\n    </div>\\n  </form>\\n</div>\";\n\n    Editor.prototype.options = {};\n\n    function Editor(options) {\n      this.onCancelButtonMouseover = __bind(this.onCancelButtonMouseover, this);\n      this.processKeypress = __bind(this.processKeypress, this);\n      this.submit = __bind(this.submit, this);\n      this.load = __bind(this.load, this);\n      this.hide = __bind(this.hide, this);\n      this.show = __bind(this.show, this);\n      Editor.__super__.constructor.call(this, $(this.html)[0], options);\n      this.fields = [];\n      this.annotation = {};\n    }\n\n    Editor.prototype.show = function(event) {\n      Annotator.Util.preventEventDefault(event);\n      this.element.removeClass(this.classes.hide);\n      this.element.find('.annotator-save').addClass(this.classes.focus);\n      this.checkOrientation();\n      this.element.find(\":input:first\").focus();\n      this.setupDraggables();\n      return this.publish('show');\n    };\n\n    Editor.prototype.hide = function(event) {\n      Annotator.Util.preventEventDefault(event);\n      this.element.addClass(this.classes.hide);\n      return this.publish('hide');\n    };\n\n    Editor.prototype.load = function(annotation) {\n      var field, _k, _len2, _ref2;\n      this.annotation = annotation;\n      this.publish('load', [this.annotation]);\n      _ref2 = this.fields;\n      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n        field = _ref2[_k];\n        field.load(field.element, this.annotation);\n      }\n      return this.show();\n    };\n\n    Editor.prototype.submit = function(event) {\n      var field, _k, _len2, _ref2;\n      Annotator.Util.preventEventDefault(event);\n      _ref2 = this.fields;\n      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n        field = _ref2[_k];\n        field.submit(field.element, this.annotation);\n      }\n      this.publish('save', [this.annotation]);\n      return this.hide();\n    };\n\n    Editor.prototype.addField = function(options) {\n      var element, field, input;\n      field = $.extend({\n        id: 'annotator-field-' + Annotator.Util.uuid(),\n        type: 'input',\n        label: '',\n        load: function() {},\n        submit: function() {}\n      }, options);\n      input = null;\n      element = $('<li class=\"annotator-item\" />');\n      field.element = element[0];\n      switch (field.type) {\n        case 'textarea':\n          input = $('<textarea />');\n          break;\n        case 'input':\n        case 'checkbox':\n          input = $('<input />');\n          break;\n        case 'select':\n          input = $('<select />');\n      }\n      element.append(input);\n      input.attr({\n        id: field.id,\n        placeholder: field.label\n      });\n      if (field.type === 'checkbox') {\n        input[0].type = 'checkbox';\n        element.addClass('annotator-checkbox');\n        element.append($('<label />', {\n          \"for\": field.id,\n          html: field.label\n        }));\n      }\n      this.element.find('ul:first').append(element);\n      this.fields.push(field);\n      return field.element;\n    };\n\n    Editor.prototype.checkOrientation = function() {\n      var controls, list;\n      Editor.__super__.checkOrientation.apply(this, arguments);\n      list = this.element.find('ul');\n      controls = this.element.find('.annotator-controls');\n      if (this.element.hasClass(this.classes.invert.y)) {\n        controls.insertBefore(list);\n      } else if (controls.is(':first-child')) {\n        controls.insertAfter(list);\n      }\n      return this;\n    };\n\n    Editor.prototype.processKeypress = function(event) {\n      if (event.keyCode === 27) {\n        return this.hide();\n      } else if (event.keyCode === 13 && !event.shiftKey) {\n        return this.submit();\n      }\n    };\n\n    Editor.prototype.onCancelButtonMouseover = function() {\n      return this.element.find('.' + this.classes.focus).removeClass(this.classes.focus);\n    };\n\n    Editor.prototype.setupDraggables = function() {\n      var classes, controls, cornerItem, editor, mousedown, onMousedown, onMousemove, onMouseup, resize, textarea, throttle;\n      this.element.find('.annotator-resize').remove();\n      if (this.element.hasClass(this.classes.invert.y)) {\n        cornerItem = this.element.find('.annotator-item:last');\n      } else {\n        cornerItem = this.element.find('.annotator-item:first');\n      }\n      if (cornerItem) {\n        $('<span class=\"annotator-resize\"></span>').appendTo(cornerItem);\n      }\n      mousedown = null;\n      classes = this.classes;\n      editor = this.element;\n      textarea = null;\n      resize = editor.find('.annotator-resize');\n      controls = editor.find('.annotator-controls');\n      throttle = false;\n      onMousedown = function(event) {\n        if (event.target === this) {\n          mousedown = {\n            element: this,\n            top: event.pageY,\n            left: event.pageX\n          };\n          textarea = editor.find('textarea:first');\n          $(window).bind({\n            'mouseup.annotator-editor-resize': onMouseup,\n            'mousemove.annotator-editor-resize': onMousemove\n          });\n          return event.preventDefault();\n        }\n      };\n      onMouseup = function() {\n        mousedown = null;\n        return $(window).unbind('.annotator-editor-resize');\n      };\n      onMousemove = (function(_this) {\n        return function(event) {\n          var diff, directionX, directionY, height, width;\n          if (mousedown && throttle === false) {\n            diff = {\n              top: event.pageY - mousedown.top,\n              left: event.pageX - mousedown.left\n            };\n            if (mousedown.element === resize[0]) {\n              height = textarea.outerHeight();\n              width = textarea.outerWidth();\n              directionX = editor.hasClass(classes.invert.x) ? -1 : 1;\n              directionY = editor.hasClass(classes.invert.y) ? 1 : -1;\n              textarea.height(height + (diff.top * directionY));\n              textarea.width(width + (diff.left * directionX));\n              if (textarea.outerHeight() !== height) {\n                mousedown.top = event.pageY;\n              }\n              if (textarea.outerWidth() !== width) {\n                mousedown.left = event.pageX;\n              }\n            } else if (mousedown.element === controls[0]) {\n              editor.css({\n                top: parseInt(editor.css('top'), 10) + diff.top,\n                left: parseInt(editor.css('left'), 10) + diff.left\n              });\n              mousedown.top = event.pageY;\n              mousedown.left = event.pageX;\n            }\n            throttle = true;\n            return setTimeout(function() {\n              return throttle = false;\n            }, 1000 / 60);\n          }\n        };\n      })(this);\n      resize.bind('mousedown', onMousedown);\n      return controls.bind('mousedown', onMousedown);\n    };\n\n    return Editor;\n\n  })(Annotator.Widget);\n\n  Annotator.Viewer = (function(_super) {\n    __extends(Viewer, _super);\n\n    Viewer.prototype.events = {\n      \".annotator-edit click\": \"onEditClick\",\n      \".annotator-delete click\": \"onDeleteClick\"\n    };\n\n    Viewer.prototype.classes = {\n      hide: 'annotator-hide',\n      showControls: 'annotator-visible'\n    };\n\n    Viewer.prototype.html = {\n      element: \"<div class=\\\"annotator-outer annotator-viewer\\\">\\n  <ul class=\\\"annotator-widget annotator-listing\\\"></ul>\\n</div>\",\n      item: \"<li class=\\\"annotator-annotation annotator-item\\\">\\n  <span class=\\\"annotator-controls\\\">\\n    <a href=\\\"#\\\" title=\\\"View as webpage\\\" class=\\\"annotator-link\\\">View as webpage</a>\\n    <button title=\\\"Edit\\\" class=\\\"annotator-edit\\\">Edit</button>\\n    <button title=\\\"Delete\\\" class=\\\"annotator-delete\\\">Delete</button>\\n  </span>\\n</li>\"\n    };\n\n    Viewer.prototype.options = {\n      readOnly: false\n    };\n\n    function Viewer(options) {\n      this.onDeleteClick = __bind(this.onDeleteClick, this);\n      this.onEditClick = __bind(this.onEditClick, this);\n      this.load = __bind(this.load, this);\n      this.hide = __bind(this.hide, this);\n      this.show = __bind(this.show, this);\n      Viewer.__super__.constructor.call(this, $(this.html.element)[0], options);\n      this.item = $(this.html.item)[0];\n      this.fields = [];\n      this.annotations = [];\n    }\n\n    Viewer.prototype.show = function(event) {\n      var controls;\n      Annotator.Util.preventEventDefault(event);\n      controls = this.element.find('.annotator-controls').addClass(this.classes.showControls);\n      setTimeout(((function(_this) {\n        return function() {\n          return controls.removeClass(_this.classes.showControls);\n        };\n      })(this)), 500);\n      this.element.removeClass(this.classes.hide);\n      return this.checkOrientation().publish('show');\n    };\n\n    Viewer.prototype.isShown = function() {\n      return !this.element.hasClass(this.classes.hide);\n    };\n\n    Viewer.prototype.hide = function(event) {\n      Annotator.Util.preventEventDefault(event);\n      this.element.addClass(this.classes.hide);\n      return this.publish('hide');\n    };\n\n    Viewer.prototype.load = function(annotations) {\n      var annotation, controller, controls, del, edit, element, field, item, link, links, list, _k, _l, _len2, _len3, _ref2, _ref3;\n      this.annotations = annotations || [];\n      list = this.element.find('ul:first').empty();\n      _ref2 = this.annotations;\n      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n        annotation = _ref2[_k];\n        item = $(this.item).clone().appendTo(list).data('annotation', annotation);\n        controls = item.find('.annotator-controls');\n        link = controls.find('.annotator-link');\n        edit = controls.find('.annotator-edit');\n        del = controls.find('.annotator-delete');\n        links = new LinkParser(annotation.links || []).get('alternate', {\n          'type': 'text/html'\n        });\n        if (links.length === 0 || (links[0].href == null)) {\n          link.remove();\n        } else {\n          link.attr('href', links[0].href);\n        }\n        if (this.options.readOnly) {\n          edit.remove();\n          del.remove();\n        } else {\n          controller = {\n            showEdit: function() {\n              return edit.removeAttr('disabled');\n            },\n            hideEdit: function() {\n              return edit.attr('disabled', 'disabled');\n            },\n            showDelete: function() {\n              return del.removeAttr('disabled');\n            },\n            hideDelete: function() {\n              return del.attr('disabled', 'disabled');\n            }\n          };\n        }\n        _ref3 = this.fields;\n        for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {\n          field = _ref3[_l];\n          element = $(field.element).clone().appendTo(item)[0];\n          field.load(element, annotation, controller);\n        }\n      }\n      this.publish('load', [this.annotations]);\n      return this.show();\n    };\n\n    Viewer.prototype.addField = function(options) {\n      var field;\n      field = $.extend({\n        load: function() {}\n      }, options);\n      field.element = $('<div />')[0];\n      this.fields.push(field);\n      field.element;\n      return this;\n    };\n\n    Viewer.prototype.onEditClick = function(event) {\n      return this.onButtonClick(event, 'edit');\n    };\n\n    Viewer.prototype.onDeleteClick = function(event) {\n      return this.onButtonClick(event, 'delete');\n    };\n\n    Viewer.prototype.onButtonClick = function(event, type) {\n      var item;\n      item = $(event.target).parents('.annotator-annotation');\n      return this.publish(type, [item.data('annotation')]);\n    };\n\n    return Viewer;\n\n  })(Annotator.Widget);\n\n  LinkParser = (function() {\n    function LinkParser(data) {\n      this.data = data;\n    }\n\n    LinkParser.prototype.get = function(rel, cond) {\n      var d, k, keys, match, v, _k, _len2, _ref2, _results;\n      if (cond == null) {\n        cond = {};\n      }\n      cond = $.extend({}, cond, {\n        rel: rel\n      });\n      keys = (function() {\n        var _results;\n        _results = [];\n        for (k in cond) {\n          if (!__hasProp.call(cond, k)) continue;\n          v = cond[k];\n          _results.push(k);\n        }\n        return _results;\n      })();\n      _ref2 = this.data;\n      _results = [];\n      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n        d = _ref2[_k];\n        match = keys.reduce((function(m, k) {\n          return m && (d[k] === cond[k]);\n        }), true);\n        if (match) {\n          _results.push(d);\n        } else {\n          continue;\n        }\n      }\n      return _results;\n    };\n\n    return LinkParser;\n\n  })();\n\n  Annotator = Annotator || {};\n\n  Annotator.Notification = (function(_super) {\n    __extends(Notification, _super);\n\n    Notification.prototype.events = {\n      \"click\": \"hide\"\n    };\n\n    Notification.prototype.options = {\n      html: \"<div class='annotator-notice'></div>\",\n      classes: {\n        show: \"annotator-notice-show\",\n        info: \"annotator-notice-info\",\n        success: \"annotator-notice-success\",\n        error: \"annotator-notice-error\"\n      }\n    };\n\n    function Notification(options) {\n      this.hide = __bind(this.hide, this);\n      this.show = __bind(this.show, this);\n      Notification.__super__.constructor.call(this, $(this.options.html).appendTo(document.body)[0], options);\n    }\n\n    Notification.prototype.show = function(message, status) {\n      if (status == null) {\n        status = Annotator.Notification.INFO;\n      }\n      this.currentStatus = status;\n      $(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(Util.escape(message || \"\"));\n      setTimeout(this.hide, 5000);\n      return this;\n    };\n\n    Notification.prototype.hide = function() {\n      if (this.currentStatus == null) {\n        this.currentStatus = Annotator.Notification.INFO;\n      }\n      $(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]);\n      return this;\n    };\n\n    return Notification;\n\n  })(Delegator);\n\n  Annotator.Notification.INFO = 'info';\n\n  Annotator.Notification.SUCCESS = 'success';\n\n  Annotator.Notification.ERROR = 'error';\n\n  $(function() {\n    var notification;\n    notification = new Annotator.Notification;\n    Annotator.showNotification = notification.show;\n    return Annotator.hideNotification = notification.hide;\n  });\n\n  Annotator.Plugin.Unsupported = (function(_super) {\n    __extends(Unsupported, _super);\n\n    function Unsupported() {\n      return Unsupported.__super__.constructor.apply(this, arguments);\n    }\n\n    Unsupported.prototype.options = {\n      message: Annotator._t(\"Sorry your current browser does not support the Annotator\")\n    };\n\n    Unsupported.prototype.pluginInit = function() {\n      if (!Annotator.supported()) {\n        return $((function(_this) {\n          return function() {\n            Annotator.showNotification(_this.options.message);\n            if ((window.XMLHttpRequest === void 0) && (ActiveXObject !== void 0)) {\n              return $('html').addClass('ie6');\n            }\n          };\n        })(this));\n      }\n    };\n\n    return Unsupported;\n\n  })(Annotator.Plugin);\n\n  createDateFromISO8601 = function(string) {\n    var d, date, offset, regexp, time, _ref2;\n    regexp = \"([0-9]{4})(-([0-9]{2})(-([0-9]{2})\" + \"(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\\\.([0-9]+))?)?\" + \"(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?\";\n    d = string.match(new RegExp(regexp));\n    offset = 0;\n    date = new Date(d[1], 0, 1);\n    if (d[3]) {\n      date.setMonth(d[3] - 1);\n    }\n    if (d[5]) {\n      date.setDate(d[5]);\n    }\n    if (d[7]) {\n      date.setHours(d[7]);\n    }\n    if (d[8]) {\n      date.setMinutes(d[8]);\n    }\n    if (d[10]) {\n      date.setSeconds(d[10]);\n    }\n    if (d[12]) {\n      date.setMilliseconds(Number(\"0.\" + d[12]) * 1000);\n    }\n    if (d[14]) {\n      offset = (Number(d[16]) * 60) + Number(d[17]);\n      offset *= (_ref2 = d[15] === '-') != null ? _ref2 : {\n        1: -1\n      };\n    }\n    offset -= date.getTimezoneOffset();\n    time = Number(date) + (offset * 60 * 1000);\n    date.setTime(Number(time));\n    return date;\n  };\n\n  base64Decode = function(data) {\n    var ac, b64, bits, dec, h1, h2, h3, h4, i, o1, o2, o3, tmp_arr;\n    if (typeof atob !== \"undefined\" && atob !== null) {\n      return atob(data);\n    } else {\n      b64 = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n      i = 0;\n      ac = 0;\n      dec = \"\";\n      tmp_arr = [];\n      if (!data) {\n        return data;\n      }\n      data += '';\n      while (i < data.length) {\n        h1 = b64.indexOf(data.charAt(i++));\n        h2 = b64.indexOf(data.charAt(i++));\n        h3 = b64.indexOf(data.charAt(i++));\n        h4 = b64.indexOf(data.charAt(i++));\n        bits = h1 << 18 | h2 << 12 | h3 << 6 | h4;\n        o1 = bits >> 16 & 0xff;\n        o2 = bits >> 8 & 0xff;\n        o3 = bits & 0xff;\n        if (h3 === 64) {\n          tmp_arr[ac++] = String.fromCharCode(o1);\n        } else if (h4 === 64) {\n          tmp_arr[ac++] = String.fromCharCode(o1, o2);\n        } else {\n          tmp_arr[ac++] = String.fromCharCode(o1, o2, o3);\n        }\n      }\n      return tmp_arr.join('');\n    }\n  };\n\n  base64UrlDecode = function(data) {\n    var i, m, _k, _ref2;\n    m = data.length % 4;\n    if (m !== 0) {\n      for (i = _k = 0, _ref2 = 4 - m; 0 <= _ref2 ? _k < _ref2 : _k > _ref2; i = 0 <= _ref2 ? ++_k : --_k) {\n        data += '=';\n      }\n    }\n    data = data.replace(/-/g, '+');\n    data = data.replace(/_/g, '/');\n    return base64Decode(data);\n  };\n\n  parseToken = function(token) {\n    var head, payload, sig, _ref2;\n    _ref2 = token.split('.'), head = _ref2[0], payload = _ref2[1], sig = _ref2[2];\n    return JSON.parse(base64UrlDecode(payload));\n  };\n\n  Annotator.Plugin.Auth = (function(_super) {\n    __extends(Auth, _super);\n\n    Auth.prototype.options = {\n      token: null,\n      tokenUrl: '/auth/token',\n      autoFetch: true\n    };\n\n    function Auth(element, options) {\n      Auth.__super__.constructor.apply(this, arguments);\n      this.waitingForToken = [];\n      if (this.options.token) {\n        this.setToken(this.options.token);\n      } else {\n        this.requestToken();\n      }\n    }\n\n    Auth.prototype.requestToken = function() {\n      this.requestInProgress = true;\n      return $.ajax({\n        url: this.options.tokenUrl,\n        dataType: 'text',\n        xhrFields: {\n          withCredentials: true\n        }\n      }).done((function(_this) {\n        return function(data, status, xhr) {\n          return _this.setToken(data);\n        };\n      })(this)).fail((function(_this) {\n        return function(xhr, status, err) {\n          var msg;\n          msg = Annotator._t(\"Couldn't get auth token:\");\n          console.error(\"\" + msg + \" \" + err, xhr);\n          return Annotator.showNotification(\"\" + msg + \" \" + xhr.responseText, Annotator.Notification.ERROR);\n        };\n      })(this)).always((function(_this) {\n        return function() {\n          return _this.requestInProgress = false;\n        };\n      })(this));\n    };\n\n    Auth.prototype.setToken = function(token) {\n      var _results;\n      this.token = token;\n      this._unsafeToken = parseToken(token);\n      if (this.haveValidToken()) {\n        if (this.options.autoFetch) {\n          this.refreshTimeout = setTimeout(((function(_this) {\n            return function() {\n              return _this.requestToken();\n            };\n          })(this)), (this.timeToExpiry() - 2) * 1000);\n        }\n        this.updateHeaders();\n        _results = [];\n        while (this.waitingForToken.length > 0) {\n          _results.push(this.waitingForToken.pop()(this._unsafeToken));\n        }\n        return _results;\n      } else {\n        console.warn(Annotator._t(\"Didn't get a valid token.\"));\n        if (this.options.autoFetch) {\n          console.warn(Annotator._t(\"Getting a new token in 10s.\"));\n          return setTimeout(((function(_this) {\n            return function() {\n              return _this.requestToken();\n            };\n          })(this)), 10 * 1000);\n        }\n      }\n    };\n\n    Auth.prototype.haveValidToken = function() {\n      var allFields;\n      allFields = this._unsafeToken && this._unsafeToken.issuedAt && this._unsafeToken.ttl && this._unsafeToken.consumerKey;\n      if (allFields && this.timeToExpiry() > 0) {\n        return true;\n      } else {\n        return false;\n      }\n    };\n\n    Auth.prototype.timeToExpiry = function() {\n      var expiry, issue, now, timeToExpiry;\n      now = new Date().getTime() / 1000;\n      issue = createDateFromISO8601(this._unsafeToken.issuedAt).getTime() / 1000;\n      expiry = issue + this._unsafeToken.ttl;\n      timeToExpiry = expiry - now;\n      if (timeToExpiry > 0) {\n        return timeToExpiry;\n      } else {\n        return 0;\n      }\n    };\n\n    Auth.prototype.updateHeaders = function() {\n      var current;\n      current = this.element.data('annotator:headers');\n      return this.element.data('annotator:headers', $.extend(current, {\n        'x-annotator-auth-token': this.token\n      }));\n    };\n\n    Auth.prototype.withToken = function(callback) {\n      if (callback == null) {\n        return;\n      }\n      if (this.haveValidToken()) {\n        return callback(this._unsafeToken);\n      } else {\n        this.waitingForToken.push(callback);\n        if (!this.requestInProgress) {\n          return this.requestToken();\n        }\n      }\n    };\n\n    return Auth;\n\n  })(Annotator.Plugin);\n\n  Annotator.Plugin.Store = (function(_super) {\n    __extends(Store, _super);\n\n    Store.prototype.events = {\n      'annotationCreated': 'annotationCreated',\n      'annotationDeleted': 'annotationDeleted',\n      'annotationUpdated': 'annotationUpdated'\n    };\n\n    Store.prototype.options = {\n      annotationData: {},\n      emulateHTTP: false,\n      loadFromSearch: false,\n      prefix: '/store',\n      urls: {\n        create: '/annotations',\n        read: '/annotations/:id',\n        update: '/annotations/:id',\n        destroy: '/annotations/:id',\n        search: '/search'\n      }\n    };\n\n    function Store(element, options) {\n      this._onError = __bind(this._onError, this);\n      this._onLoadAnnotationsFromSearch = __bind(this._onLoadAnnotationsFromSearch, this);\n      this._onLoadAnnotations = __bind(this._onLoadAnnotations, this);\n      this._getAnnotations = __bind(this._getAnnotations, this);\n      Store.__super__.constructor.apply(this, arguments);\n      this.annotations = [];\n    }\n\n    Store.prototype.pluginInit = function() {\n      if (!Annotator.supported()) {\n        return;\n      }\n      if (this.annotator.plugins.Auth) {\n        return this.annotator.plugins.Auth.withToken(this._getAnnotations);\n      } else {\n        return this._getAnnotations();\n      }\n    };\n\n    Store.prototype._getAnnotations = function() {\n      if (this.options.loadFromSearch) {\n        return this.loadAnnotationsFromSearch(this.options.loadFromSearch);\n      } else {\n        return this.loadAnnotations();\n      }\n    };\n\n    Store.prototype.annotationCreated = function(annotation) {\n      if (__indexOf.call(this.annotations, annotation) < 0) {\n        this.registerAnnotation(annotation);\n        return this._apiRequest('create', annotation, (function(_this) {\n          return function(data) {\n            if (data.id == null) {\n              console.warn(Annotator._t(\"Warning: No ID returned from server for annotation \"), annotation);\n            }\n            return _this.updateAnnotation(annotation, data);\n          };\n        })(this));\n      } else {\n        return this.updateAnnotation(annotation, {});\n      }\n    };\n\n    Store.prototype.annotationUpdated = function(annotation) {\n      if (__indexOf.call(this.annotations, annotation) >= 0) {\n        return this._apiRequest('update', annotation, ((function(_this) {\n          return function(data) {\n            return _this.updateAnnotation(annotation, data);\n          };\n        })(this)));\n      }\n    };\n\n    Store.prototype.annotationDeleted = function(annotation) {\n      if (__indexOf.call(this.annotations, annotation) >= 0) {\n        return this._apiRequest('destroy', annotation, ((function(_this) {\n          return function() {\n            return _this.unregisterAnnotation(annotation);\n          };\n        })(this)));\n      }\n    };\n\n    Store.prototype.registerAnnotation = function(annotation) {\n      return this.annotations.push(annotation);\n    };\n\n    Store.prototype.unregisterAnnotation = function(annotation) {\n      return this.annotations.splice(this.annotations.indexOf(annotation), 1);\n    };\n\n    Store.prototype.updateAnnotation = function(annotation, data) {\n      if (__indexOf.call(this.annotations, annotation) < 0) {\n        console.error(Annotator._t(\"Trying to update unregistered annotation!\"));\n      } else {\n        $.extend(annotation, data);\n      }\n      return $(annotation.highlights).data('annotation', annotation);\n    };\n\n    Store.prototype.loadAnnotations = function() {\n      return this._apiRequest('read', null, this._onLoadAnnotations);\n    };\n\n    Store.prototype._onLoadAnnotations = function(data) {\n      var a, annotation, annotationMap, newData, _k, _l, _len2, _len3, _ref2;\n      if (data == null) {\n        data = [];\n      }\n      annotationMap = {};\n      _ref2 = this.annotations;\n      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n        a = _ref2[_k];\n        annotationMap[a.id] = a;\n      }\n      newData = [];\n      for (_l = 0, _len3 = data.length; _l < _len3; _l++) {\n        a = data[_l];\n        if (annotationMap[a.id]) {\n          annotation = annotationMap[a.id];\n          this.updateAnnotation(annotation, a);\n        } else {\n          newData.push(a);\n        }\n      }\n      this.annotations = this.annotations.concat(newData);\n      return this.annotator.loadAnnotations(newData.slice());\n    };\n\n    Store.prototype.loadAnnotationsFromSearch = function(searchOptions) {\n      return this._apiRequest('search', searchOptions, this._onLoadAnnotationsFromSearch);\n    };\n\n    Store.prototype._onLoadAnnotationsFromSearch = function(data) {\n      if (data == null) {\n        data = {};\n      }\n      return this._onLoadAnnotations(data.rows || []);\n    };\n\n    Store.prototype.dumpAnnotations = function() {\n      var ann, _k, _len2, _ref2, _results;\n      _ref2 = this.annotations;\n      _results = [];\n      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n        ann = _ref2[_k];\n        _results.push(JSON.parse(this._dataFor(ann)));\n      }\n      return _results;\n    };\n\n    Store.prototype._apiRequest = function(action, obj, onSuccess) {\n      var id, options, request, url;\n      id = obj && obj.id;\n      url = this._urlFor(action, id);\n      options = this._apiRequestOptions(action, obj, onSuccess);\n      request = $.ajax(url, options);\n      request._id = id;\n      request._action = action;\n      return request;\n    };\n\n    Store.prototype._apiRequestOptions = function(action, obj, onSuccess) {\n      var data, method, opts;\n      method = this._methodFor(action);\n      opts = {\n        type: method,\n        headers: this.element.data('annotator:headers'),\n        dataType: \"json\",\n        success: onSuccess || function() {},\n        error: this._onError\n      };\n      if (this.options.emulateHTTP && (method === 'PUT' || method === 'DELETE')) {\n        opts.headers = $.extend(opts.headers, {\n          'X-HTTP-Method-Override': method\n        });\n        opts.type = 'POST';\n      }\n      if (action === \"search\") {\n        opts = $.extend(opts, {\n          data: obj\n        });\n        return opts;\n      }\n      data = obj && this._dataFor(obj);\n      if (this.options.emulateJSON) {\n        opts.data = {\n          json: data\n        };\n        if (this.options.emulateHTTP) {\n          opts.data._method = method;\n        }\n        return opts;\n      }\n      opts = $.extend(opts, {\n        data: data,\n        contentType: \"application/json; charset=utf-8\"\n      });\n      return opts;\n    };\n\n    Store.prototype._urlFor = function(action, id) {\n      var url;\n      url = this.options.prefix != null ? this.options.prefix : '';\n      url += this.options.urls[action];\n      url = url.replace(/\\/:id/, id != null ? '/' + id : '');\n      url = url.replace(/:id/, id != null ? id : '');\n      return url;\n    };\n\n    Store.prototype._methodFor = function(action) {\n      var table;\n      table = {\n        'create': 'POST',\n        'read': 'GET',\n        'update': 'PUT',\n        'destroy': 'DELETE',\n        'search': 'GET'\n      };\n      return table[action];\n    };\n\n    Store.prototype._dataFor = function(annotation) {\n      var data, highlights;\n      highlights = annotation.highlights;\n      delete annotation.highlights;\n      $.extend(annotation, this.options.annotationData);\n      data = JSON.stringify(annotation);\n      if (highlights) {\n        annotation.highlights = highlights;\n      }\n      return data;\n    };\n\n    Store.prototype._onError = function(xhr) {\n      var action, message;\n      action = xhr._action;\n      message = Annotator._t(\"Sorry we could not \") + action + Annotator._t(\" this annotation\");\n      if (xhr._action === 'search') {\n        message = Annotator._t(\"Sorry we could not search the store for annotations\");\n      } else if (xhr._action === 'read' && !xhr._id) {\n        message = Annotator._t(\"Sorry we could not \") + action + Annotator._t(\" the annotations from the store\");\n      }\n      switch (xhr.status) {\n        case 401:\n          message = Annotator._t(\"Sorry you are not allowed to \") + action + Annotator._t(\" this annotation\");\n          break;\n        case 404:\n          message = Annotator._t(\"Sorry we could not connect to the annotations store\");\n          break;\n        case 500:\n          message = Annotator._t(\"Sorry something went wrong with the annotation store\");\n      }\n      Annotator.showNotification(message, Annotator.Notification.ERROR);\n      return console.error(Annotator._t(\"API request failed:\") + (\" '\" + xhr.status + \"'\"));\n    };\n\n    return Store;\n\n  })(Annotator.Plugin);\n\n  Annotator.Plugin.Permissions = (function(_super) {\n    __extends(Permissions, _super);\n\n    Permissions.prototype.events = {\n      'beforeAnnotationCreated': 'addFieldsToAnnotation'\n    };\n\n    Permissions.prototype.options = {\n      showViewPermissionsCheckbox: true,\n      showEditPermissionsCheckbox: true,\n      userId: function(user) {\n        return user;\n      },\n      userString: function(user) {\n        return user;\n      },\n      userAuthorize: function(action, annotation, user) {\n        var token, tokens, _k, _len2;\n        if (annotation.permissions) {\n          tokens = annotation.permissions[action] || [];\n          if (tokens.length === 0) {\n            return true;\n          }\n          for (_k = 0, _len2 = tokens.length; _k < _len2; _k++) {\n            token = tokens[_k];\n            if (this.userId(user) === token) {\n              return true;\n            }\n          }\n          return false;\n        } else if (annotation.user) {\n          if (user) {\n            return this.userId(user) === this.userId(annotation.user);\n          } else {\n            return false;\n          }\n        }\n        return true;\n      },\n      user: '',\n      permissions: {\n        'read': [],\n        'update': [],\n        'delete': [],\n        'admin': []\n      }\n    };\n\n    function Permissions(element, options) {\n      this._setAuthFromToken = __bind(this._setAuthFromToken, this);\n      this.updateViewer = __bind(this.updateViewer, this);\n      this.updateAnnotationPermissions = __bind(this.updateAnnotationPermissions, this);\n      this.updatePermissionsField = __bind(this.updatePermissionsField, this);\n      this.addFieldsToAnnotation = __bind(this.addFieldsToAnnotation, this);\n      Permissions.__super__.constructor.apply(this, arguments);\n      if (this.options.user) {\n        this.setUser(this.options.user);\n        delete this.options.user;\n      }\n    }\n\n    Permissions.prototype.pluginInit = function() {\n      var createCallback, self;\n      if (!Annotator.supported()) {\n        return;\n      }\n      self = this;\n      createCallback = function(method, type) {\n        return function(field, annotation) {\n          return self[method].call(self, type, field, annotation);\n        };\n      };\n      if (!this.user && this.annotator.plugins.Auth) {\n        this.annotator.plugins.Auth.withToken(this._setAuthFromToken);\n      }\n      if (this.options.showViewPermissionsCheckbox === true) {\n        this.annotator.editor.addField({\n          type: 'checkbox',\n          label: Annotator._t('Allow anyone to <strong>view</strong> this annotation'),\n          load: createCallback('updatePermissionsField', 'read'),\n          submit: createCallback('updateAnnotationPermissions', 'read')\n        });\n      }\n      if (this.options.showEditPermissionsCheckbox === true) {\n        this.annotator.editor.addField({\n          type: 'checkbox',\n          label: Annotator._t('Allow anyone to <strong>edit</strong> this annotation'),\n          load: createCallback('updatePermissionsField', 'update'),\n          submit: createCallback('updateAnnotationPermissions', 'update')\n        });\n      }\n      this.annotator.viewer.addField({\n        load: this.updateViewer\n      });\n      if (this.annotator.plugins.Filter) {\n        return this.annotator.plugins.Filter.addFilter({\n          label: Annotator._t('User'),\n          property: 'user',\n          isFiltered: (function(_this) {\n            return function(input, user) {\n              var keyword, _k, _len2, _ref2;\n              user = _this.options.userString(user);\n              if (!(input && user)) {\n                return false;\n              }\n              _ref2 = input.split(/\\s*/);\n              for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n                keyword = _ref2[_k];\n                if (user.indexOf(keyword) === -1) {\n                  return false;\n                }\n              }\n              return true;\n            };\n          })(this)\n        });\n      }\n    };\n\n    Permissions.prototype.setUser = function(user) {\n      return this.user = user;\n    };\n\n    Permissions.prototype.addFieldsToAnnotation = function(annotation) {\n      if (annotation) {\n        annotation.permissions = this.options.permissions;\n        if (this.user) {\n          return annotation.user = this.user;\n        }\n      }\n    };\n\n    Permissions.prototype.authorize = function(action, annotation, user) {\n      if (user === void 0) {\n        user = this.user;\n      }\n      if (this.options.userAuthorize) {\n        return this.options.userAuthorize.call(this.options, action, annotation, user);\n      } else {\n        return true;\n      }\n    };\n\n    Permissions.prototype.updatePermissionsField = function(action, field, annotation) {\n      var input;\n      field = $(field).show();\n      input = field.find('input').removeAttr('disabled');\n      if (!this.authorize('admin', annotation)) {\n        field.hide();\n      }\n      if (this.authorize(action, annotation || {}, null)) {\n        return input.attr('checked', 'checked');\n      } else {\n        return input.removeAttr('checked');\n      }\n    };\n\n    Permissions.prototype.updateAnnotationPermissions = function(type, field, annotation) {\n      var dataKey;\n      if (!annotation.permissions) {\n        annotation.permissions = this.options.permissions;\n      }\n      dataKey = type + '-permissions';\n      if ($(field).find('input').is(':checked')) {\n        return annotation.permissions[type] = [];\n      } else {\n        return annotation.permissions[type] = [this.options.userId(this.user)];\n      }\n    };\n\n    Permissions.prototype.updateViewer = function(field, annotation, controls) {\n      var user, username;\n      field = $(field);\n      username = this.options.userString(annotation.user);\n      if (annotation.user && username && typeof username === 'string') {\n        user = Annotator.Util.escape(this.options.userString(annotation.user));\n        field.html(user).addClass('annotator-user');\n      } else {\n        field.remove();\n      }\n      if (controls) {\n        if (!this.authorize('update', annotation)) {\n          controls.hideEdit();\n        }\n        if (!this.authorize('delete', annotation)) {\n          return controls.hideDelete();\n        }\n      }\n    };\n\n    Permissions.prototype._setAuthFromToken = function(token) {\n      return this.setUser(token.userId);\n    };\n\n    return Permissions;\n\n  })(Annotator.Plugin);\n\n  Annotator.Plugin.AnnotateItPermissions = (function(_super) {\n    __extends(AnnotateItPermissions, _super);\n\n    function AnnotateItPermissions() {\n      this._setAuthFromToken = __bind(this._setAuthFromToken, this);\n      this.updateAnnotationPermissions = __bind(this.updateAnnotationPermissions, this);\n      this.updatePermissionsField = __bind(this.updatePermissionsField, this);\n      this.addFieldsToAnnotation = __bind(this.addFieldsToAnnotation, this);\n      return AnnotateItPermissions.__super__.constructor.apply(this, arguments);\n    }\n\n    AnnotateItPermissions.prototype.options = {\n      showViewPermissionsCheckbox: true,\n      showEditPermissionsCheckbox: true,\n      groups: {\n        world: 'group:__world__',\n        authenticated: 'group:__authenticated__',\n        consumer: 'group:__consumer__'\n      },\n      userId: function(user) {\n        return user.userId;\n      },\n      userString: function(user) {\n        return user.userId;\n      },\n      userAuthorize: function(action, annotation, user) {\n        var action_field, permissions, _ref2, _ref3, _ref4, _ref5;\n        permissions = annotation.permissions || {};\n        action_field = permissions[action] || [];\n        if (_ref2 = this.groups.world, __indexOf.call(action_field, _ref2) >= 0) {\n          return true;\n        } else if ((user != null) && (user.userId != null) && (user.consumerKey != null)) {\n          if (user.userId === annotation.user && user.consumerKey === annotation.consumer) {\n            return true;\n          } else if (_ref3 = this.groups.authenticated, __indexOf.call(action_field, _ref3) >= 0) {\n            return true;\n          } else if (user.consumerKey === annotation.consumer && (_ref4 = this.groups.consumer, __indexOf.call(action_field, _ref4) >= 0)) {\n            return true;\n          } else if (user.consumerKey === annotation.consumer && (_ref5 = user.userId, __indexOf.call(action_field, _ref5) >= 0)) {\n            return true;\n          } else if (user.consumerKey === annotation.consumer && user.admin) {\n            return true;\n          } else {\n            return false;\n          }\n        } else {\n          return false;\n        }\n      },\n      permissions: {\n        'read': ['group:__world__'],\n        'update': [],\n        'delete': [],\n        'admin': []\n      }\n    };\n\n    AnnotateItPermissions.prototype.addFieldsToAnnotation = function(annotation) {\n      if (annotation) {\n        annotation.permissions = this.options.permissions;\n        if (this.user) {\n          annotation.user = this.user.userId;\n          return annotation.consumer = this.user.consumerKey;\n        }\n      }\n    };\n\n    AnnotateItPermissions.prototype.updatePermissionsField = function(action, field, annotation) {\n      var input;\n      field = $(field).show();\n      input = field.find('input').removeAttr('disabled');\n      if (!this.authorize('admin', annotation)) {\n        field.hide();\n      }\n      if (this.user && this.authorize(action, annotation || {}, {\n        userId: '__nonexistentuser__',\n        consumerKey: this.user.consumerKey\n      })) {\n        return input.attr('checked', 'checked');\n      } else {\n        return input.removeAttr('checked');\n      }\n    };\n\n    AnnotateItPermissions.prototype.updateAnnotationPermissions = function(type, field, annotation) {\n      var dataKey;\n      if (!annotation.permissions) {\n        annotation.permissions = this.options.permissions;\n      }\n      dataKey = type + '-permissions';\n      if ($(field).find('input').is(':checked')) {\n        return annotation.permissions[type] = [type === 'read' ? this.options.groups.world : this.options.groups.consumer];\n      } else {\n        return annotation.permissions[type] = [];\n      }\n    };\n\n    AnnotateItPermissions.prototype._setAuthFromToken = function(token) {\n      return this.setUser(token);\n    };\n\n    return AnnotateItPermissions;\n\n  })(Annotator.Plugin.Permissions);\n\n  Annotator.Plugin.Filter = (function(_super) {\n    __extends(Filter, _super);\n\n    Filter.prototype.events = {\n      \".annotator-filter-property input focus\": \"_onFilterFocus\",\n      \".annotator-filter-property input blur\": \"_onFilterBlur\",\n      \".annotator-filter-property input keyup\": \"_onFilterKeyup\",\n      \".annotator-filter-previous click\": \"_onPreviousClick\",\n      \".annotator-filter-next click\": \"_onNextClick\",\n      \".annotator-filter-clear click\": \"_onClearClick\"\n    };\n\n    Filter.prototype.classes = {\n      active: 'annotator-filter-active',\n      hl: {\n        hide: 'annotator-hl-filtered',\n        active: 'annotator-hl-active'\n      }\n    };\n\n    Filter.prototype.html = {\n      element: \"<div class=\\\"annotator-filter\\\">\\n  <strong>\" + Annotator._t('Navigate:') + \"</strong>\\n<span class=\\\"annotator-filter-navigation\\\">\\n  <button class=\\\"annotator-filter-previous\\\">\" + Annotator._t('Previous') + \"</button>\\n<button class=\\\"annotator-filter-next\\\">\" + Annotator._t('Next') + \"</button>\\n</span>\\n<strong>\" + Annotator._t('Filter by:') + \"</strong>\\n</div>\",\n      filter: \"<span class=\\\"annotator-filter-property\\\">\\n  <label></label>\\n  <input/>\\n  <button class=\\\"annotator-filter-clear\\\">\" + Annotator._t('Clear') + \"</button>\\n</span>\"\n    };\n\n    Filter.prototype.options = {\n      appendTo: 'body',\n      filters: [],\n      addAnnotationFilter: true,\n      isFiltered: function(input, property) {\n        var keyword, _k, _len2, _ref2;\n        if (!(input && property)) {\n          return false;\n        }\n        _ref2 = input.split(/\\s+/);\n        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n          keyword = _ref2[_k];\n          if (property.indexOf(keyword) === -1) {\n            return false;\n          }\n        }\n        return true;\n      }\n    };\n\n    function Filter(element, options) {\n      this._onPreviousClick = __bind(this._onPreviousClick, this);\n      this._onNextClick = __bind(this._onNextClick, this);\n      this._onFilterKeyup = __bind(this._onFilterKeyup, this);\n      this._onFilterBlur = __bind(this._onFilterBlur, this);\n      this._onFilterFocus = __bind(this._onFilterFocus, this);\n      this.updateHighlights = __bind(this.updateHighlights, this);\n      var _base;\n      element = $(this.html.element).appendTo((options != null ? options.appendTo : void 0) || this.options.appendTo);\n      Filter.__super__.constructor.call(this, element, options);\n      (_base = this.options).filters || (_base.filters = []);\n      this.filter = $(this.html.filter);\n      this.filters = [];\n      this.current = 0;\n    }\n\n    Filter.prototype.pluginInit = function() {\n      var filter, _k, _len2, _ref2;\n      _ref2 = this.options.filters;\n      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n        filter = _ref2[_k];\n        this.addFilter(filter);\n      }\n      this.updateHighlights();\n      this._setupListeners()._insertSpacer();\n      if (this.options.addAnnotationFilter === true) {\n        return this.addFilter({\n          label: Annotator._t('Annotation'),\n          property: 'text'\n        });\n      }\n    };\n\n    Filter.prototype.destroy = function() {\n      var currentMargin, html;\n      Filter.__super__.destroy.apply(this, arguments);\n      html = $('html');\n      currentMargin = parseInt(html.css('padding-top'), 10) || 0;\n      html.css('padding-top', currentMargin - this.element.outerHeight());\n      return this.element.remove();\n    };\n\n    Filter.prototype._insertSpacer = function() {\n      var currentMargin, html;\n      html = $('html');\n      currentMargin = parseInt(html.css('padding-top'), 10) || 0;\n      html.css('padding-top', currentMargin + this.element.outerHeight());\n      return this;\n    };\n\n    Filter.prototype._setupListeners = function() {\n      var event, events, _k, _len2;\n      events = ['annotationsLoaded', 'annotationCreated', 'annotationUpdated', 'annotationDeleted'];\n      for (_k = 0, _len2 = events.length; _k < _len2; _k++) {\n        event = events[_k];\n        this.annotator.subscribe(event, this.updateHighlights);\n      }\n      return this;\n    };\n\n    Filter.prototype.addFilter = function(options) {\n      var f, filter;\n      filter = $.extend({\n        label: '',\n        property: '',\n        isFiltered: this.options.isFiltered\n      }, options);\n      if (!((function() {\n        var _k, _len2, _ref2, _results;\n        _ref2 = this.filters;\n        _results = [];\n        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n          f = _ref2[_k];\n          if (f.property === filter.property) {\n            _results.push(f);\n          }\n        }\n        return _results;\n      }).call(this)).length) {\n        filter.id = 'annotator-filter-' + filter.property;\n        filter.annotations = [];\n        filter.element = this.filter.clone().appendTo(this.element);\n        filter.element.find('label').html(filter.label).attr('for', filter.id);\n        filter.element.find('input').attr({\n          id: filter.id,\n          placeholder: Annotator._t('Filter by ') + filter.label + '\\u2026'\n        });\n        filter.element.find('button').hide();\n        filter.element.data('filter', filter);\n        this.filters.push(filter);\n      }\n      return this;\n    };\n\n    Filter.prototype.updateFilter = function(filter) {\n      var annotation, annotations, input, property, _k, _len2, _ref2;\n      filter.annotations = [];\n      this.updateHighlights();\n      this.resetHighlights();\n      input = $.trim(filter.element.find('input').val());\n      if (input) {\n        annotations = this.highlights.map(function() {\n          return $(this).data('annotation');\n        });\n        _ref2 = $.makeArray(annotations);\n        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n          annotation = _ref2[_k];\n          property = annotation[filter.property];\n          if (filter.isFiltered(input, property)) {\n            filter.annotations.push(annotation);\n          }\n        }\n        return this.filterHighlights();\n      }\n    };\n\n    Filter.prototype.updateHighlights = function() {\n      this.highlights = this.annotator.element.find('.annotator-hl:visible');\n      return this.filtered = this.highlights.not(this.classes.hl.hide);\n    };\n\n    Filter.prototype.filterHighlights = function() {\n      var activeFilters, annotation, annotations, filtered, highlights, index, uniques, _k, _len2, _ref2;\n      activeFilters = $.grep(this.filters, function(filter) {\n        return !!filter.annotations.length;\n      });\n      filtered = ((_ref2 = activeFilters[0]) != null ? _ref2.annotations : void 0) || [];\n      if (activeFilters.length > 1) {\n        annotations = [];\n        $.each(activeFilters, function() {\n          return $.merge(annotations, this.annotations);\n        });\n        uniques = [];\n        filtered = [];\n        $.each(annotations, function() {\n          if ($.inArray(this, uniques) === -1) {\n            return uniques.push(this);\n          } else {\n            return filtered.push(this);\n          }\n        });\n      }\n      highlights = this.highlights;\n      for (index = _k = 0, _len2 = filtered.length; _k < _len2; index = ++_k) {\n        annotation = filtered[index];\n        highlights = highlights.not(annotation.highlights);\n      }\n      highlights.addClass(this.classes.hl.hide);\n      this.filtered = this.highlights.not(this.classes.hl.hide);\n      return this;\n    };\n\n    Filter.prototype.resetHighlights = function() {\n      this.highlights.removeClass(this.classes.hl.hide);\n      this.filtered = this.highlights;\n      return this;\n    };\n\n    Filter.prototype._onFilterFocus = function(event) {\n      var input;\n      input = $(event.target);\n      input.parent().addClass(this.classes.active);\n      return input.next('button').show();\n    };\n\n    Filter.prototype._onFilterBlur = function(event) {\n      var input;\n      if (!event.target.value) {\n        input = $(event.target);\n        input.parent().removeClass(this.classes.active);\n        return input.next('button').hide();\n      }\n    };\n\n    Filter.prototype._onFilterKeyup = function(event) {\n      var filter;\n      filter = $(event.target).parent().data('filter');\n      if (filter) {\n        return this.updateFilter(filter);\n      }\n    };\n\n    Filter.prototype._findNextHighlight = function(previous) {\n      var active, annotation, current, index, next, offset, operator, resetOffset;\n      if (!this.highlights.length) {\n        return this;\n      }\n      offset = previous ? 0 : -1;\n      resetOffset = previous ? -1 : 0;\n      operator = previous ? 'lt' : 'gt';\n      active = this.highlights.not('.' + this.classes.hl.hide);\n      current = active.filter('.' + this.classes.hl.active);\n      if (!current.length) {\n        current = active.eq(offset);\n      }\n      annotation = current.data('annotation');\n      index = active.index(current[0]);\n      next = active.filter(\":\" + operator + \"(\" + index + \")\").not(annotation.highlights).eq(resetOffset);\n      if (!next.length) {\n        next = active.eq(resetOffset);\n      }\n      return this._scrollToHighlight(next.data('annotation').highlights);\n    };\n\n    Filter.prototype._onNextClick = function(event) {\n      return this._findNextHighlight();\n    };\n\n    Filter.prototype._onPreviousClick = function(event) {\n      return this._findNextHighlight(true);\n    };\n\n    Filter.prototype._scrollToHighlight = function(highlight) {\n      highlight = $(highlight);\n      this.highlights.removeClass(this.classes.hl.active);\n      highlight.addClass(this.classes.hl.active);\n      return $('html, body').animate({\n        scrollTop: highlight.offset().top - (this.element.height() + 20)\n      }, 150);\n    };\n\n    Filter.prototype._onClearClick = function(event) {\n      return $(event.target).prev('input').val('').keyup().blur();\n    };\n\n    return Filter;\n\n  })(Annotator.Plugin);\n\n  Annotator.Plugin.Markdown = (function(_super) {\n    __extends(Markdown, _super);\n\n    Markdown.prototype.events = {\n      'annotationViewerTextField': 'updateTextField'\n    };\n\n    function Markdown(element, options) {\n      this.updateTextField = __bind(this.updateTextField, this);\n      if ((typeof Showdown !== \"undefined\" && Showdown !== null ? Showdown.converter : void 0) != null) {\n        Markdown.__super__.constructor.apply(this, arguments);\n        this.converter = new Showdown.converter();\n      } else {\n        console.error(Annotator._t(\"To use the Markdown plugin, you must include Showdown into the page first.\"));\n      }\n    }\n\n    Markdown.prototype.updateTextField = function(field, annotation) {\n      var text;\n      text = Annotator.Util.escape(annotation.text || '');\n      return $(field).html(this.convert(text));\n    };\n\n    Markdown.prototype.convert = function(text) {\n      return this.converter.makeHtml(text);\n    };\n\n    return Markdown;\n\n  })(Annotator.Plugin);\n\n  Annotator.Plugin.Tags = (function(_super) {\n    __extends(Tags, _super);\n\n    function Tags() {\n      this.setAnnotationTags = __bind(this.setAnnotationTags, this);\n      this.updateField = __bind(this.updateField, this);\n      return Tags.__super__.constructor.apply(this, arguments);\n    }\n\n    Tags.prototype.options = {\n      parseTags: function(string) {\n        var tags;\n        string = $.trim(string);\n        tags = [];\n        if (string) {\n          tags = string.split(/\\s+/);\n        }\n        return tags;\n      },\n      stringifyTags: function(array) {\n        return array.join(\" \");\n      }\n    };\n\n    Tags.prototype.field = null;\n\n    Tags.prototype.input = null;\n\n    Tags.prototype.pluginInit = function() {\n      if (!Annotator.supported()) {\n        return;\n      }\n      this.field = this.annotator.editor.addField({\n        label: Annotator._t('Add some tags here') + '\\u2026',\n        load: this.updateField,\n        submit: this.setAnnotationTags\n      });\n      this.annotator.viewer.addField({\n        load: this.updateViewer\n      });\n      if (this.annotator.plugins.Filter) {\n        this.annotator.plugins.Filter.addFilter({\n          label: Annotator._t('Tag'),\n          property: 'tags',\n          isFiltered: Annotator.Plugin.Tags.filterCallback\n        });\n      }\n      return this.input = $(this.field).find(':input');\n    };\n\n    Tags.prototype.parseTags = function(string) {\n      return this.options.parseTags(string);\n    };\n\n    Tags.prototype.stringifyTags = function(array) {\n      return this.options.stringifyTags(array);\n    };\n\n    Tags.prototype.updateField = function(field, annotation) {\n      var value;\n      value = '';\n      if (annotation.tags) {\n        value = this.stringifyTags(annotation.tags);\n      }\n      return this.input.val(value);\n    };\n\n    Tags.prototype.setAnnotationTags = function(field, annotation) {\n      return annotation.tags = this.parseTags(this.input.val());\n    };\n\n    Tags.prototype.updateViewer = function(field, annotation) {\n      field = $(field);\n      if (annotation.tags && $.isArray(annotation.tags) && annotation.tags.length) {\n        return field.addClass('annotator-tags').html(function() {\n          var string;\n          return string = $.map(annotation.tags, function(tag) {\n            return '<span class=\"annotator-tag\">' + Annotator.Util.escape(tag) + '</span>';\n          }).join(' ');\n        });\n      } else {\n        return field.remove();\n      }\n    };\n\n    return Tags;\n\n  })(Annotator.Plugin);\n\n  Annotator.Plugin.Tags.filterCallback = function(input, tags) {\n    var keyword, keywords, matches, tag, _k, _l, _len2, _len3;\n    if (tags == null) {\n      tags = [];\n    }\n    matches = 0;\n    keywords = [];\n    if (input) {\n      keywords = input.split(/\\s+/g);\n      for (_k = 0, _len2 = keywords.length; _k < _len2; _k++) {\n        keyword = keywords[_k];\n        if (tags.length) {\n          for (_l = 0, _len3 = tags.length; _l < _len3; _l++) {\n            tag = tags[_l];\n            if (tag.indexOf(keyword) !== -1) {\n              matches += 1;\n            }\n          }\n        }\n      }\n    }\n    return matches === keywords.length;\n  };\n\n  Annotator.prototype.setupPlugins = function(config, options) {\n    var name, opts, pluginConfig, plugins, uri, win, _k, _len2, _results;\n    if (config == null) {\n      config = {};\n    }\n    if (options == null) {\n      options = {};\n    }\n    win = Annotator.Util.getGlobal();\n    plugins = ['Unsupported', 'Auth', 'Tags', 'Filter', 'Store', 'AnnotateItPermissions'];\n    if (win.Showdown) {\n      plugins.push('Markdown');\n    }\n    uri = win.location.href.split(/#|\\?/).shift() || '';\n    pluginConfig = {\n      Tags: {},\n      Filter: {\n        filters: [\n          {\n            label: Annotator._t('User'),\n            property: 'user'\n          }, {\n            label: Annotator._t('Tags'),\n            property: 'tags'\n          }\n        ]\n      },\n      Auth: {\n        tokenUrl: config.tokenUrl || 'http://annotateit.org/api/token'\n      },\n      Store: {\n        prefix: config.storeUrl || 'http://annotateit.org/api',\n        annotationData: {\n          uri: uri\n        },\n        loadFromSearch: {\n          uri: uri\n        }\n      }\n    };\n    for (name in options) {\n      if (!__hasProp.call(options, name)) continue;\n      opts = options[name];\n      if (__indexOf.call(plugins, name) < 0) {\n        plugins.push(name);\n      }\n    }\n    $.extend(true, pluginConfig, options);\n    _results = [];\n    for (_k = 0, _len2 = plugins.length; _k < _len2; _k++) {\n      name = plugins[_k];\n      if (!(name in pluginConfig) || pluginConfig[name]) {\n        _results.push(this.addPlugin(name, pluginConfig[name]));\n      } else {\n        _results.push(void 0);\n      }\n    }\n    return _results;\n  };\n\n}).call(this);\n\n//\n//# sourceMappingURL=annotator-full.map","var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Annotator.Plugin.RichText=(function(a){__extends(b,a);b.prototype.options={tinymce:{selector:\"li.annotator-item textarea\",plugins:\"media image insertdatetime link code\",menubar:false,toolbar_items_size:\"small\",extended_valid_elements:\"iframe[src|frameborder|style|scrolling|class|width|height|name|align|id]\",toolbar:\"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media rubric | code \",}};function b(d,c){_ref=b.__super__.constructor.apply(this,arguments);return _ref}b.prototype.pluginInit=function(){console.log(\"RichText-pluginInit\");var d=this.annotator,c=this.annotator.editor;if(!Annotator.supported()){return}d.editor.addField({type:\"input\",load:this.updateEditor,});d.viewer.addField({load:this.updateViewer,});d.subscribe(\"annotationEditorShown\",function(){$(d.editor.element).find(\".mce-tinymce\")[0].style.display=\"block\";$(d.editor.element).find(\".mce-container\").css(\"z-index\",3000000000);d.editor.checkOrientation()});d.subscribe(\"annotationEditorHidden\",function(){$(d.editor.element).find(\".mce-tinymce\")[0].style.display=\"none\"});this.options.tinymce.setup=function(e){e.on(\"change\",function(f){$(c.element).find(\"textarea\")[0].value=tinymce.activeEditor.getContent()});e.on(\"Init\",function(f){$(\".mce-container\").css(\"z-index\",\"3090000000000000000\")});e.addButton(\"rubric\",{icon:\"rubric\",title:\"Insert a rubric\",onclick:function(){e.windowManager.open({title:\"Insert a public rubric of the webside https://gteavirtual.org/rubric   \",body:[{type:\"textbox\",name:\"url\",label:\"Url\"}],onsubmit:function(l){var h=l.data.url,g=\"irb\",k;g=g.replace(/[\\[]/,\"\\\\[\").replace(/[\\]]/,\"\\\\]\");var j=new RegExp(\"[\\\\?&]\"+g+\"=([^&#]*)\"),i=j.exec(h);k=i==null?\"\":decodeURIComponent(i[1].replace(/\\+/g,\" \"));if(k==\"\"){e.windowManager.alert(\"Error: The given webpage didn't have a irb variable in the url\")}else{var f=\"<iframe src='https://gteavirtual.org/rubric/?mod=portal&scr=viewrb&evt=frame&irb=\"+k+\"' style='width:800px;height:600px;overflow-y: scroll;background:transparent' frameborder='0' ></iframe>\";e.setContent(e.getContent()+f);$(c.element).find(\"textarea\")[0].value=e.getContent()}}});e.insertContent(\"Main button\");e.label=\"My Button\"}})};tinymce.init(this.options.tinymce)};b.prototype.updateEditor=function(d,c){var e=typeof c.text!=\"undefined\"?c.text:\"\";tinymce.activeEditor.setContent(e);$(d).remove()};b.prototype.updateViewer=function(e,c){var d=$(e.parentNode).find(\"div:first-of-type\")[0];d.innerHTML=c.text;$(d).addClass(\"richText-annotation\");$(e).remove()};return b})(Annotator.Plugin);","/**\n * Created by flyx on 7/22/15.\n */\nAnnotator.Plugin.ImageAnnotation = function (element, settings) {\n\n    var scope = this;\n    var _element = element;\n    this.template = '';\n    this.target = null;\n    this.x = 0;\n    this.y = 0;\n    this.inEdit = false;\n\n    this.init = function() {\n        $('.annotator-wrapper')\n            .append($('<div>').attr('id','img-anno-list'));\n\n    };\n\n    this.getSelectionText = function(){\n        var text = \"\";\n        if (window.getSelection) {\n            text = window.getSelection().toString();\n        } else if (document.selection && document.selection.type != \"Control\") {\n            text = document.selection.createRange().text;\n        }\n        return text;\n    };\n\n    this.imageHoverListener = function(e) {\n        if( scope.getSelectionText() == '') {\n            scope.target = e.currentTarget;\n            var offset = $('.annotator-wrapper').offset();\n            var curX = e.pageX - offset.left;\n            var curY = e.pageY - offset.top + 25;\n\n            var editor = $('.annotator-editor');\n            if (editor.css('display') == 'none'\n                || editor.hasClass('annotator-hide')) {\n                $('.annotator-adder')\n                    .css('left', curX)\n                    .css('top', curY)\n                    .removeClass('annotator-hide')\n                    .show();\n\n            }\n\n            if(!scope.inEdit) {\n                scope.target = e.currentTarget;\n                scope.x = e.pageX - $(scope.target).offset().left;\n                scope.y = e.pageY - $(scope.target).offset().top;\n            }\n\n\n        }\n\n    };\n\n    this.imageInListener = function(e) {\n        //滑鼠在圖片上時，是否要更新 adder 的座標\n        if(scope.getSelectionText() == '' && !scope.inEdit) {\n            scope.target = e.currentTarget;\n            scope.x = e.pageX - $(scope.target).offset().left;\n            scope.y = e.pageY - $(scope.target).offset().top;\n        }\n    };\n\n    this.addHook = function() {\n\n        $('.annotator-wrapper')\n            .on('mousemove', function (e) {\n\n                if( scope.getSelectionText() == '') {\n                    var curX = e.pageX ;\n                    var curY = e.pageY ;\n                    var target = $(scope.target);\n                    if (  scope.target != null\n                        && !(scope.target != null\n                        && ( curX >= target.offset().left\n                        && curX <= target.offset().left + target.width()\n                        && curY >= target.offset().top\n                        && curY <= target.offset().top + target.height() ))) {\n\n                        $('.annotator-adder').hide();\n\n                    }\n                }\n            });\n\n        //圖片hook\n        $(_element)\n            .find('img')\n            .on('mousemove', this.imageHoverListener)\n            .on('mouseenter', this.imageInListener);\n\n\n        $('.annotator-adder')\n            .on('click', function (e) {\n                var offset = $('.annotator-wrapper').offset();\n                var curX = e.pageX - offset.left;\n                var curY = e.pageY - offset.top + 15;\n\n                if(scope.getSelectionText() == '') {\n                    scope.inEdit = true;\n                    $('.annotator-editor')\n                        .css('left', curX)\n                        .css('top', curY)\n                        .removeClass('annotator-hide')\n                        .show();\n                }\n            });\n\n        $('#cancel')\n            .on('click', function(e) {\n                scope.inEdit = false;\n            });\n\n        $(_element)\n            .on('mouseover', '.anno-img-item', function(e) {\n                $('.annotator-adder').hide();\n            });\n    };\n\n\n\n\n    return {\n        pluginInit: function () {\n\n            scope.init();\n            scope.addHook();\n\n            this.annotator\n                .subscribe(\"annotationCreated\", function (annotation) {\n                    if( scope.target != null ) {\n                        annotation.type = 'image';\n                        annotation.src = scope.target.src;\n                        annotation.position = {\n                            x: scope.x,\n                            y: scope.y\n                        };\n                        if(annotation.type == 'image') {\n                            var origin = $(\".annotator-wrapper img[src='\"+annotation.src+\"']\").position();\n                            var x = parseInt(origin.left) + parseInt(annotation.position.x);\n                            var y = parseInt(origin.top) + parseInt(annotation.position.y);\n                            $('#img-anno-list')\n                                .append($('<div>')\n                                    .attr('id','img-anno-' + annotation.id)\n                                    .addClass('fa').addClass('fa-chevron-circle-down')\n                                    .addClass('fa-2x').addClass('annotator-hl').addClass('img-anno-item')\n                                    .css({\n                                        'position' :'absoulte',\n                                        'z-index' : '999',\n                                        'left' : x + 'px',\n                                        'top' : y + 'px'\n                                    }));\n\n                            $('#img-anno-' + annotation.id)\n                                .data('annotation', annotation);\n                        }\n                    }\n                }).subscribe(\"annotationDeleted\", function (annotation) {\n\n                    if(annotation.type == 'image') {\n                        $('#img-anno-' + annotation.id).remove();\n                    }\n                })\n                .subscribe(\"annotationsLoaded\", function (annotations) {\n                    for(var i = 0 ; i < annotations.length; i++) {\n                        var annotation = annotations[i];\n                        if(annotation.type == 'image') {\n                            var origin = $(\".annotator-wrapper img[src='\"+annotation.src+\"']\").position();\n                            var x = parseInt(origin.left) + parseInt(annotation.position.x);\n                            var y = parseInt(origin.top) + parseInt(annotation.position.y);\n                            $('#img-anno-list')\n                                .append($('<div>')\n                                    .attr('id'+ 'img-anno-' + annotation.id)\n                                    .addClass('fa').addClass('fa-chevron-circle-down').addClass('fa-2x')\n                                    .addClass('annotator-hl').addClass('img-anno-item')\n                                    .css( {\n                                        'position' :'absoulte',\n                                        'z-index' : '999',\n                                        'left' : x + 'px',\n                                        'top' : y + 'px'\n                                    }));\n                            $('#img-anno-' + annotation.id)\n                                .data('annotation', annotation);\n                        }\n                    }\n                });\n        }\n    }\n}\n","/**\n * 顯示Annotation的插件\n */\nAnnotator.Plugin.ViewPanel = function (element, settings) {\n\n    // storing object scope\n    var _this = this;\n    this.settings = settings;\n    this.annotator = $(element).annotator().data('annotator');\n    this.element = element;\n    this.uri = settings.uri;\n    // if uri not set , use web url in default\n    if(this.uri == null)\n        this.uri = location.href.split('#')[0];\n\n    this.anno_token = settings.anno_token;\n    this.target_anno = settings.target_anno;\n    this.server = settings.server;\n\n    this.domain = settings.domain;\n    this.callback_url = location.href.split('#')[0];\n\n    // Storing entire data;\n    this.data = [];\n    // Storing data that only showed;\n    this.showing = [];\n    // Mapping hights elements by id;\n    this.maptoid= {};\n\n    // Authed variable\n    this.is_authed = false;\n\n    // Panel Object\n    this.ui = null;\n\n    // API URLS\n    this.postlikeUrl = 'http://' + this.server + '/api/likes';\n    this.authCheckurl = 'http://' + this.server + '/api/check';\n    this.loginUrl = 'http://' + this.server + '/auth/login?callback_url='\n    + encodeURIComponent(this.callback_url)  + '&uri=' + this.uri + '&domain=' + this.domain ;\n    this.logoutUrl = 'http://' + this.server + '/api/logout';\n\n    this.showUI = true;\n    this.user = null;\n\n    //登入Anntation的 Modal UI\n    this.insertAuthUI = function() {\n        $('body').append('<div id=\"openAuthUI\" class=\"authDialog\">'\n        + '     <div>'\n        + '         <h2>本網站使用了標記的服務</h2>'\n        + '         <span><a id=\"anno-btn-login\" class=\"btn anno-btn-login\">永久儲存標記</a></span>'\n        + '         <span><a href=\"#\" id=\"anno-btn-close\" class=\"btn anno-btn-close\">關閉視窗</a></span>'\n        + '     </div>'\n        + '</div>');\n\n        $(document)\n            .on('click', '#anno-btn-login', function(e) {\n                location.href = _this.loginUrl;\n            })\n            .on('click', '#anno-btn-close', function(e) {\n                $('#openAuthUI').removeClass('show');\n                return false;\n            })\n            .on('click', '.annotator-adder', function(e) {\n                if(!_this.is_authed) {\n                    $('#openAuthUI').addClass('show');\n                    $('.annotator-cancel').click();\n                }\n            });\n\n    };\n\n    this.insertPanelUI = function() {\n\n        $('body').append(\n            '<div class=\"anno-panel\">' +\n                '<div class=\"anno-login\">' +\n                '</div>' +\n                '<div class=\"anno-search\">' +\n                    '<p><strong>搜尋標記內容</strong></p>' +\n                    '<form action=\"#\" id=\"form-search\">' +\n                        '<button id=\"anno-search-submit\" type=\"submit\">' +\n                            '<i class=\"fa fa-search fa-2x\"></i>' +\n                        '</button>' +\n                        '<input id=\"anno-search-input\" type=\"text\" />' +\n                    '</form>' +\n                '</div>' +\n                '<div class=\"anno-users\">' +\n                    '<p><strong>在此網頁標記的人</strong></p>' +\n                    '<ul>' +\n                    '</ul>' +\n                '</div>' +\n                '<div class=\"anno-tags\"><p><strong>標籤</strong></p>' +\n                    '<ul>' +\n                    '</ul>' +\n                '</div>' +\n                '<hr/>' +\n                '<div class=\"anno-search-list\">' +\n                    '<ul>' +\n                    '</ul>' +\n                '</div>' +\n                '<div class=\"anno-viewall\">' +\n                    '<button class=\"btn-viewall\" id=\"btn-viewall\">顯示全部</button>' +\n                '</div>' +\n                '<div class=\"btn-appear\">' +\n                '</div>' +\n            '</div>');\n\n        _this.ui = $('.anno-panel');\n\n        if(_this.target_anno == 0) {\n            $('.anno-viewall').hide();\n        } else {\n            $('.anno-search').hide();\n            $('.anno-users').hide();\n            $('.anno-tags').hide();\n            $('.anno-search-list').hide();\n        }\n\n        $('#btn-viewall').click(function(e){\n            _this.target_anno = 0;\n            $('.annotator-hl').not('.hl-keywords').removeClass('annotator-hl');\n            $('.anno-tags ul li').remove();\n            $('.anno-users ul li').remove();\n            _this.annotator.loadAnnotations(_this.data);\n            $('.anno-search').fadeIn();\n            $('.anno-users').fadeIn();\n            $('.anno-tags').fadeIn();\n            $('.anno-search-list').fadeIn();\n            $('.anno-viewall').hide();\n\n        });\n\n        //綁定搜尋按鈕事件\n        $('#anno-search-submit').click(function(e) {\n            e.preventDefault();\n            //從Store插件找到搜尋的網址\n            var url_search = _this.annotator.plugins.Store.options.urls.search;\n            var data = _this.annotator.plugins.Store.options.loadFromSearch;\n            data.search = _this.ui.find('#anno-search-input').val();\n            $.ajax({\n                url: url_search,\n                data: data,\n                dataType: 'json',\n                success: function(data) {\n                    _this.data = [];\n                    $('.annotator-hl').not('.hl-keywords').removeClass('annotator-hl');\n                    $('.anno-tags ul li').remove();\n                    $('.anno-users ul li').remove();\n                    _this.annotator.loadAnnotations(data.rows);\n                }\n            });\n        });\n\n        //綁定所有按讚事件\n        $(document).on( 'click', '.anno-like',function(e) {\n            e.preventDefault();\n            var target = $(e.target);\n            //標記ID\n            var aid = target.attr('data-id');\n            $.post(_this.postlikeUrl + \"/\" + aid, {\n                anno_token : _this.anno_token,\n                domain : _this.domain,\n                like : '1'\n            }).success(function(annotation) {\n                target.parent().find('.annotator-likes-total').text(annotation.likes);\n                if(_this.maptoid[annotation.id] != null) {\n                    var highlights = _this.maptoid[annotation.id];\n                    highlights.forEach(function(highlight, index , ary) {\n                        $(highlight).data('annotation').likes = annotation.likes;\n                    });\n                }\n            });\n\n        }).on( 'click', '.anno-dislike',function(e) {\n            e.preventDefault();\n            var target = $(e.target);\n            var aid = target.attr('data-id');\n            $.post(_this.postlikeUrl + \"/\" + aid, {\n                anno_token : _this.anno_token,\n                domain : _this.domain,\n                like : '-1'\n            }).success(function(annotation) {\n                target.parent().find('.annotator-likes-total').text(annotation.likes);\n                if(_this.maptoid[annotation.id] != null) {\n                    var highlights = _this.maptoid[annotation.id];\n                    highlights.forEach(function(highlight, index , ary) {\n                        $(highlight).data('annotation').likes = annotation.likes;\n                    });\n                }\n            });\n\n        });\n\n        //登出事件\n        $(document).on('click','#btn-anno-logout', function(e){\n            e.preventDefault();\n            $.ajax({\n                method: 'POST',\n                cookies: true,\n                async: false,\n                data: {\n                    'anno_token': _this.anno_token,\n                    'domain' : _this.domain\n                },\n                url : _this.logoutUrl\n            });\n            setCookie('anno_token', '');\n            setCookie('user_id', 0);\n            _this.is_authed = false;\n            _this.anno_token = '';\n            _this.checkLoginState(false);\n            location.reload();\n            return false;\n        });\n\n\n        _this.ui.bind('mouseover', function(e){\n            if(!_this.showUI) {\n                _this.ui.stop().animate({\n                    'right': '0'\n                }, 500, 'linear');\n                _this.showUI = true;\n            }\n        }).bind('mouseleave',  function(e){\n            if(_this.showUI) {\n                _this.ui.stop().animate({\n                    'right': '-260px'\n                }, 1000, 'linear');\n                _this.showUI = false;\n            }\n        });\n    };\n\n\n    //檢查登入狀態函數\n    this.checkLoginState = function(showUI, async) {\n\n        if(!this.is_authed) {\n            $.ajax({\n                crossDomain : true,\n                async: async === true,\n                dataType: 'json',\n                data: {\n                    'anno_token': this.anno_token,\n                    'domain' : this.domain\n                },\n                url: this.authCheckurl,\n                success : function(data) {\n                    $(_this.element).data('annotator-user', data.user);\n                    _this.user = data.user;\n                    $('.anno-login').html(\n                        '<img class=\"gravatar\" src=\"'+ data.user.gravatar+'\"/>' +\n                        '<div>' +\n                            '<span>'+ data.user.email +'</span>' +\n                        '</div>' +\n                        '<div>' +\n                        '<span>' +\n                            '<a href=\"#\" id=\"btn-anno-logout\">登出</a>' +\n                        '</span>' +\n                        '<span>' +\n                            '<a target=\"_blank\" href=\"http://' + _this.server + '\">管理標記</a>' +\n                        '</span>' +\n                        '</div>');\n                },\n                statusCode: {\n                    200 : function() {\n                        _this.is_authed = true;\n                    },\n                    401: function () {\n                        $('.anno-login').html('<div><span><a href=\"' + _this.loginUrl +'\">登入</a></span></div>');\n                        if(showUI != false)\n                            $('#openAuthUI').addClass('show');\n                    }\n                }\n            });\n        }\n    };\n\n\n    this.refreshHighLights = function() {\n\n        var filter_users = [];\n        var filter_tags = [];\n        var i;\n\n        //抓出user list 跟 tag list 的勾選input\n        var checkboxs = $('.anno-tags ul li input[type=checkbox],.anno-users ul li input[type=checkbox]');\n\n        var tags_count = $('.anno-tags ul li input[type=checkbox]').length;\n\n\n        for(i = 0 ; i < checkboxs.length; i++) {\n            if(checkboxs[i].checked) {\n                //種類\n                var cls = $(checkboxs[i]).attr('data-search').split('-')[0];\n                //id\n                var val = $(checkboxs[i]).attr('data-search').split('-')[1];\n                if( cls == 'user')\n                {\n                    filter_users.push(val);\n                } else if ( cls == 'tag' ) {\n                    filter_tags.push(val);\n                }\n            }\n        }\n\n\n        //顯示用的資料，完整的資料存在_this.data\n        _this.showing = [];\n\n        //開始搜尋\n        for(i = 0 ; i < _this.data.length; i++)\n        {\n            var user = _this.data[i].user;\n\n            _this.data[i].highlights = [];\n\n            // 確認建立標記的使用者\n            if (filter_users.indexOf(user.id.toString()) != -1) {\n                //如果tag清單上沒有全部勾選 則確認標記的tag\n                if(filter_tags.length != tags_count) {\n                    var tags = _this.data[i].tags;\n                    for (var j = 0; j < tags.length; j++) {\n                        var tag = tags[j];\n                        if (filter_tags.indexOf(tag) != -1) {\n                            _this.showing.push(_this.data[i]);\n                            break;\n                        }\n                    }\n                } else {\n                    _this.showing.push(_this.data[i]);\n                }\n            }\n\n        }\n\n        $('.annotator-hl').not('.hl-keywords').removeClass('annotator-hl');\n\n        _this.annotator.loadAnnotations(_this.showing);\n\n    };\n\n    this.addReference = function(annotation) {\n\n        var user_id;\n        var gravatar_url = '#';\n\n        // get user id from annotation\n        if( annotation.user != null)\n            user_id = annotation.user.id;\n\n        if( user_id == null )\n            user_id = _this.user.id;\n\n        // not authed\n        if( annotation.id == 0 || annotation.id == null)\n            annotation.user = _this.user;\n\n        var user = annotation.user;\n\n        if ( user.gravatar == null)\n            user = _this.user;\n\n        // get user gravatar url\n        gravatar_url = user.gravatar;\n\n\n\n        // check user is added to userlist\n        if( _this.ui.find('#anno-user-'+ user_id ).length == 0) {\n            //add user list item and bind to user list\n            _this.ui.find('.anno-users ul')\n                .append('<li id=\"anno-user-' + user_id + '\">' +\n                            '<input type=\"checkbox\" checked data-search=\"user-' + user_id + '\"/>' +\n                            '<img class=\"gravatar\" src=\"'+ gravatar_url +'\" alt=\"\"/>' +\n                            '<span>' + user.name +'</span>' +\n                        '</li>');\n            $('#anno-user-' + user_id)\n                .find('input[type=checkbox]')\n                .click(_this.refreshHighLights);\n        }\n\n        //add tag to tag list\n        var tags = annotation.tags;\n\n        if( Array.isArray(tags)) tags.forEach(function (tagName, index, tagsAry) {\n            if (tagName !== '') {\n                var tagId = 'anno-tag-' + tagName;\n                if (!_this.ui.find('#' + tagId).length) {\n                    _this.ui.find('.anno-tags ul')\n                        .append($('<li>').attr('id', tagId)\n                            .append($('<input>').attr('type', 'checkbox')\n                                .attr('checked', '')\n                                .attr('data-search', 'tag-' + tagName))\n                            .append($('<span>').text(tagName)));\n                    $('#' + tagId).find('input[type=checkbox]')\n                        .click(_this.refreshHighLights);\n                }\n            }\n        });\n    };\n\n    // add user filed to Annotation View\n    this.updateCreatorViewer = function(field, annotation) {\n        var user = annotation.user;\n        if(user == null)\n            user = _this.user;\n        if(user.name != null ) {\n            $(field)\n                .addClass('annotator-user')\n                .html($('<strong>').text('建立者: ')\n                    .append($('<span>')\n                        .text(user.name)));\n        }\n        return '';\n    };\n\n    this.updateDateViewer = function(field, annotation) {\n\n        if(annotation.created_at != null ) {\n            $(field)\n                .addClass('annotator-date')\n                .html($('<strong>').text('建立時間: ')\n                    .append($('<span>')\n                        .text(annotation.created_at)));\n        }\n        return '';\n    };\n\n\n    this.updateLikeViewer = function(field, annotation) {\n        if(annotation.likes != undefined ){\n            $(field)\n                .addClass('annotator-mark')\n                .html('<strong>評分: </strong>' +\n                '<span class=\"annotator-likes\">' +\n                '<span class=\"annotator-likes-total\">'+annotation.likes+'</span>' +\n                '<a href=\"#\" data-id=\"'+ annotation.id +'\" class=\"anno-like fa fa-thumbs-up\"></a>' +\n                '<a href=\"#\" data-id=\"'+ annotation.id +'\" class=\"anno-dislike fa fa-thumbs-down\"></a>' +\n                '</span>');\n        }\n\n        return '';\n    };\n\n    return {\n        pluginInit: function () {\n\n            _this.insertPanelUI();\n            _this.insertAuthUI();\n            _this.checkLoginState(false);\n            _this.annotator\n\n                .subscribe(\"annotationsLoaded\", function (annotations) {\n                    if( _this.data.length == 0 )\n                        _this.data = annotations;\n                    annotations.forEach(function(annotation, index, annotations) {\n                        var isInArray = $.inArray(_this.data, annotation);\n                        if(~isInArray)\n                            _this.data.push(annotation);\n                        _this.addReference(annotation);\n                        //建立 id以及被標記元素的map\n                        if( annotation.highlights != null) {\n                            _this.maptoid[annotation.id] = annotation.highlights;\n                        }\n                        // 當要顯示特定標記時，刪除其他標記的高亮\n                        if(_this.target_anno != 0) {\n                            if (annotation.id.toString() != _this.target_anno && annotation.highlights != null) {\n                                annotation.highlights.forEach(function(highlight, index, highlights){\n                                    $(highlight).not('.hl-keywords').removeClass('annotator-hl');\n                                });\n                            }\n\n                        }\n                    });\n\n            }).subscribe(\"annotationCreated\", function (annotation) {\n                _this.checkLoginState();\n                if(_this.data.indexOf(annotation) == -1)\n                    _this.data.push(annotation);\n                _this.addReference(annotation);\n            }).subscribe(\"annotationUpdated\", function (annotation) {\n                _this.checkLoginState();\n                _this.addReference(annotation);\n            }).subscribe(\"annotationDeleted\", function (annotation) {\n                _this.checkLoginState();\n                var index = $.inArray(annotation, _this.data);\n                if( ~index )\n                    _this.data.splice(index, 1);\n            });\n\n            _this.annotator.viewer.addField({\n                load: _this.updateCreatorViewer\n            });\n\n            _this.annotator.viewer.addField({\n                load: _this.updateLikeViewer\n            });\n\n            _this.annotator.viewer.addField({\n                load: _this.updateDateViewer\n            });\n        }\n    }\n};\n","/**\n * Created by flyx on 8/21/15.\n */\n/**\n * Created by flyx on 7/22/15.\n */\nAnnotator.Plugin.Keyword = function (element, settings) {\n\n    var _this = this;\n    var _element = element;\n    var keyword_index = 1;\n    this.data = [];\n    this.keywordUrl = 'http://140.109.18.158/api/annotation.jsp';\n\n    function clone(obj) {\n        if (null == obj || \"object\" != typeof obj) return obj;\n        var copy = obj.constructor();\n        for (var attr in obj) {\n            if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];\n        }\n        return copy;\n    }\n\n\n    this.init = function() {\n        $.ajax(_this.keywordUrl , {\n            method: 'POST',\n\n            crossDomain: true,\n            dataType: 'json',\n            data :{\n                text : $(element).html()\n            },\n            success: function(data) {\n\n                for( i in data) {\n                    var row = data[i];\n                    $(_element).html(\n                        $(_element)\n                            .html()\n                            .replace(new RegExp(row.keyword, \"g\"),\n                            $('<div>').append(\n                                $('<span/>').attr('id', 'keyword-' + row.id).addClass('annotator-hl').html(row.keyword)).html()\n                        )\n                    );\n                }\n\n                for ( var i in data) {\n                    var row = data[i];\n\n                    $('.annotator-hl').filter('#keyword-' + row.id).each(function(index) {\n\n                            var obj = new function() {\n\n                                return {\n                                    \"id\": \"keyword-\" + keyword_index.toString(),  // unique id (added by backend)\n                                    \"text\": row.description,                  // content of annotation\n                                    \"quote\": row.description,    // the annotated text (added by frontend)\n                                    \"uri\": \"\",\n                                    \"domain\": \"\",\n                                    \"link\": \"\",\n                                    \"ranges\": [                                // list of ranges covered by annotation (usually only one entry)\n                                        {\n                                            \"start\": \"\",           // (relative) XPath to start element\n                                            \"end\": \"\",             // (relative) XPath to end element\n                                            \"startOffset\": 0,                      // character offset within start element\n                                            \"endOffset\": 0                       // character offset within end element\n                                        }\n                                    ],\n                                    \"user\": {\n                                        id: '0',\n                                        gravatar:'',\n                                        email: ''\n                                    },                           // user id of annotation owner (can also be an object with an 'id' property)\n                                    \"type\": \"text\",\n                                    \"position\": {\n                                        \"x\": \"0\",\n                                        \"y\": \"0\"\n                                    },\n                                    \"tags\": [],             // list of tags (from Tags plugin)\n                                    \"likes\": 0,\n                                    \"src\": \"\",\n                                    \"permissions\": {                           //annotation permissions (from Permissions/AnnotateItPermissions plugin)\n                                        \"read\": [],\n                                        \"update\": [0],\n                                        \"delete\": [0]\n                                    }\n                                };\n                            }();\n\n                            $(this).addClass('hl-keywords').data('annotation',obj);\n                            keyword_index++;\n                        });\n                }\n            }\n        });\n\n    };\n\n    return {\n        pluginInit: function () {\n            _this.init();\n        }\n    };\n\n};\n","/**\n * Created by flyx on 7/6/15.\n */\n\nfunction deleteCookie( name, path, domain ) {\n    if( getCookie( name ) ) {\n        document.cookie = name + \"=\" +\n        ((path) ? \";path=\"+location.host:\"\")+\n        ((domain)?\";domain=\"+domain:\"\") +\n        \";expires=Thu, 01 Jan 1970 00:00:01 GMT\";\n    }\n}\n\nfunction setCookie(cname, cvalue, exdays) {\n    var d = new Date();\n    d.setTime(d.getTime() + (exdays*24*60*60*1000));\n    var expires = \"expires=\"+d.toUTCString();\n    document.cookie = cname + \"=\" + cvalue + \";path=\" + location.host +  \"; \" + expires;\n}\n\nfunction getCookie(cname) {\n    var name = cname + \"=\";\n    var ca = document.cookie.split(';');\n    for(var i=0; i<ca.length; i++) {\n        var c = ca[i];\n        while (c.charAt(0)==' ') c = c.substring(1);\n        if (c.indexOf(name) == 0) return c.substring(name.length, c.length);\n    }\n    return \"\";\n}\n\nfunction getHashParam(name) {\n    name = name.replace(/[\\[]/, \"\\\\[\").replace(/[\\]]/, \"\\\\]\");\n    var regex = new RegExp(\"[&#]\" + name + \"=([^&#]*)\"),\n        results = regex.exec(location.hash);\n    return results === null ? \"\" : decodeURIComponent(results[1].replace(/\\+/g, \" \"));\n}\n\nvar annotation = function(e) {\n\n    this.server_host = 'annotation.ipicbox.tw';\n    this.element = e;\n    this.annotator = null;\n    this.host = location.host;\n    var _annotation = this;\n\n\n    this.init = function(setting) {\n\n        if( setting.uri == null ) {\n            console.error('[Annotation Init Error]', 'uri undefined');\n            return;\n        }\n        _annotation.uri = setting.uri\n\n        // get Token from hash\n        var anno_token = getHashParam('anno_token');\n        // get user id from hash\n        var user_id = parseInt(getHashParam('user_id'));\n\n        if(isNaN(user_id))\n            user_id = 0;\n\n        var target_anno = parseInt(getHashParam('anno_id'));\n\n        if(isNaN(target_anno))\n            target_anno = 0;\n\n        var old_anno_token = getCookie('anno_token');\n        var old_user_id = getCookie('user_id');\n\n        if( anno_token == '') {\n            if (old_anno_token != \"\") {\n                anno_token = old_anno_token;\n            }\n            if( old_user_id != \"\") {\n                user_id = parseInt(old_user_id);\n            }\n        } else {\n            setCookie('anno_token', anno_token, 30);\n            setCookie('user_id', user_id, 30);\n        }\n\n        // init annotator\n        this.annotator = $(_annotation.element).annotator();\n\n        // set richText editor options\n        var optionsRichText = {\n            tinymce:{\n                selector: \"li.annotator-item textarea\",\n                plugins: \"media image insertdatetime link code\",\n                menubar: false,\n                toolbar_items_size: 'small',\n                extended_valid_elements : \"iframe[src|frameborder|style|scrolling|class|width|height|name|align|id]\",\n                toolbar: \"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media rubric | code \"\n            }\n        };\n\n        if(setting.imageAnnotation === true) {\n            this.annotator\n                .annotator('addPlugin', 'ImageAnnotation', {\n                    server: this.server_host\n                });\n        }\n\n        // set permission options\n        var permissionsOptions = {};\n        permissionsOptions['showEditPermissionsCheckbox'] = false;\n\n        this.annotator\n            .annotator('addPlugin', 'Store', {\n            prefix: '',\n            urls: {\n                create:  'http://' + this.server_host + '/api/annotations/',\n                read:    'http://' + this.server_host + '/api/annotations/:id/',\n                update:  'http://' + this.server_host + '/api/annotations/:id/',\n                destroy: 'http://' + this.server_host + '/api/annotations/:id/',\n                search:  'http://' + this.server_host + '/api/search/'\n            },\n            annotationData: {\n                uri: _annotation.uri,\n                domain : _annotation.host,\n                anno_token : anno_token,\n                likes: 0,\n                link : location.href.split('#')[0]\n            },\n            loadFromSearch: {\n                limit: 0,\n                uri: _annotation.uri,\n                domain : _annotation.host,\n                anno_token : anno_token\n            }\n        })\n            .annotator('addPlugin','RichText',optionsRichText)\n            .annotator('addPlugin', 'Tags')\n          //  .annotator('addPlugin', 'Keyword', {})\n            .annotator('addPlugin', 'ViewPanel', {\n                target_anno : target_anno,\n                anno_token : anno_token,\n                uri: _annotation.uri,\n                server : _annotation.server_host,\n                domain : _annotation.host\n            });\n        var user = this.annotator.data('annotator-user');\n        this.annotator.annotator('addPlugin', 'Permissions', {\n                showEditPermissionsCheckbox: false,\n                user: user != null ? parseInt(user.id) : 0\n            });\n\n    };\n\n    return this;\n};\n"],"sourceRoot":"/source/"}